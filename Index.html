<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ù¾Ù„Ø§Ø³ | Ù†Ø³Ø®Ù‡ Ø·Ù„Ø§ÛŒÛŒ</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { primary: '#4f46e5', secondary: '#10b981', accent: '#f43f5e', dark: '#0f172a', light: '#f8fafc' }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/auto-animate/0.7.0/auto-animate.min.js"></script>

    <style>
        /* Base & Glassmorphism */
        body { background: #f0f2f5; background-image: radial-gradient(#e0e7ff 1px, transparent 1px); background-size: 24px 24px; overflow-x: hidden; transition: background 0.3s; user-select: none; -webkit-tap-highlight-color: transparent; }
        .dark body { background: #0f172a; background-image: radial-gradient(#1e293b 1px, transparent 1px); }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05); transition: all 0.3s; }
        .dark .glass { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255, 255, 255, 0.05); color: #e2e8f0; }
        
        /* Navigation & UI */
        .nav-item.active { background: #4f46e5; color: white !important; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .dark .nav-item { color: #94a3b8; }
        .dark .nav-item.active { color: white !important; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Switch & Buttons */
        .type-switch { display: flex; background: #e2e8f0; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .dark .type-switch { background: #1e293b; }
        .type-btn { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: all 0.3s; color: #64748b; }
        .type-btn.active-expense { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .type-btn.active-transfer { background: #10b981; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

        /* Print CSS */
        @media print {
            body { background: white !important; color: black !important; padding: 0 !important; }
            .no-print, nav, header, .fab-btn, #toast-container, .view-section, button, .type-switch, .search-bar { display: none !important; }
            .print-only { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .glass { box-shadow: none !important; border: none !important; background: white !important; }
            table.print-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 10px; }
            table.print-table th, table.print-table td { border: 1px solid #333; padding: 6px; text-align: center; }
            table.print-table th { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-header h1 { font-size: 18pt; margin: 0; }
            @page { margin: 10mm; size: A4; }
        }
        .print-only { display: none; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.8rem; }
    </style>
</head>
<body class="text-slate-800 pb-24 md:pb-10 font-sans transition-colors duration-300">

    <div class="max-w-7xl mx-auto p-3 md:p-6 space-y-6 no-print">
        
        <header class="glass rounded-3xl p-3 md:p-4 flex flex-col md:flex-row items-center justify-between sticky top-2 z-40 gap-3">
            <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                        <i data-lucide="pie-chart" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-black text-lg md:text-xl tracking-tight dark:text-white">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ù¾Ù„Ø§Ø³ <span class="text-[10px] bg-amber-500 text-white px-2 py-0.5 rounded-full align-middle">Gold</span></h1>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</p>
                    </div>
                </div>
                <div class="flex gap-2 md:hidden">
                    <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-yellow-400"><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i><i data-lucide="moon" class="w-5 h-5 dark:hidden"></i></button>
                    <button onclick="showHelp()" class="bg-indigo-50 dark:bg-indigo-900/50 p-2 rounded-xl text-indigo-600 dark:text-indigo-300"><i data-lucide="help-circle" class="w-5 h-5"></i></button>
                </div>
            </div>

            <nav class="flex bg-slate-100/80 dark:bg-slate-800/80 p-1 rounded-2xl w-full md:w-auto overflow-x-auto custom-scroll">
                <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item px-3 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-all flex-1 md:flex-none justify-center"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
                <button onclick="router('transactions')" id="nav-transactions" class="nav-item px-3 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-all flex-1 md:flex-none justify-center"><i data-lucide="list-checks" class="w-4 h-4"></i> ØªØ±Ø§Ú©Ù†Ø´</button>
                <button onclick="router('reports')" id="nav-reports" class="nav-item px-3 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-all flex-1 md:flex-none justify-center"><i data-lucide="file-bar-chart" class="w-4 h-4"></i> Ú¯Ø²Ø§Ø±Ø´</button>
                <button onclick="router('members')" id="nav-members" class="nav-item px-3 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-all flex-1 md:flex-none justify-center"><i data-lucide="users" class="w-4 h-4"></i> Ø§Ø¹Ø¶Ø§</button>
                <button onclick="router('settings')" id="nav-settings" class="nav-item px-3 py-2 rounded-xl text-xs md:text-sm font-bold flex items-center gap-2 whitespace-nowrap transition-all flex-1 md:flex-none justify-center"><i data-lucide="settings" class="w-4 h-4"></i> ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
            </nav>

            <div class="hidden md:flex gap-2">
                <button onclick="toggleTheme()" class="bg-slate-200 dark:bg-slate-700 p-2.5 rounded-xl text-slate-600 dark:text-yellow-400 transition hover:scale-110">
                    <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <button onclick="showHelp()" class="bg-indigo-50 dark:bg-indigo-900/50 p-2.5 rounded-xl text-indigo-600 dark:text-indigo-300 transition hover:scale-110" title="Ø±Ø§Ù‡Ù†Ù…Ø§">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main id="view-dashboard" class="view-section space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass p-5 rounded-3xl border-b-4 border-primary relative overflow-hidden group">
                    <div class="absolute -left-4 -top-4 w-24 h-24 bg-primary/10 rounded-full blur-2xl group-hover:bg-primary/20 transition"></div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">Ú©Ù„ Ù…Ø®Ø§Ø±Ø¬ Ú¯Ø±ÙˆÙ‡</span>
                        <i data-lucide="wallet" class="text-primary w-5 h-5"></i>
                    </div>
                    <h3 id="total-expenses" class="text-2xl font-black text-slate-800 dark:text-white" dir="ltr">0</h3>
                </div>
                <div class="glass p-5 rounded-3xl border-b-4 border-secondary relative overflow-hidden group">
                    <div class="absolute -left-4 -top-4 w-24 h-24 bg-secondary/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø³Ù‡Ù… Ù‡Ø± Ù†ÙØ± (Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†)</span>
                        <i data-lucide="calculator" class="text-secondary w-5 h-5"></i>
                    </div>
                    <h3 id="avg-share" class="text-2xl font-black text-slate-800 dark:text-white" dir="ltr">0</h3>
                </div>
                <div class="glass p-5 rounded-3xl border-b-4 border-accent relative overflow-hidden group">
                    <div class="absolute -left-4 -top-4 w-24 h-24 bg-accent/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">ÙˆØ¶Ø¹ÛŒØª ØµÙ†Ø¯ÙˆÙ‚</span>
                        <i data-lucide="scale" class="text-accent w-5 h-5"></i>
                    </div>
                    <h3 id="balance-status" class="text-lg font-black mt-1">...</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <section class="lg:col-span-2 glass p-6 rounded-3xl flex flex-col md:flex-row gap-6">
                    <div class="flex-1 min-h-[220px]">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 dark:text-slate-200"><i data-lucide="pie-chart" class="text-primary w-4 h-4"></i> Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø®Ø§Ø±Ø¬</h3>
                        <div class="h-[200px] flex justify-center relative"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="w-px bg-slate-100 dark:bg-slate-700 hidden md:block"></div>
                    <div class="flex-1 min-h-[220px]">
                        <h3 class="font-bold text-sm mb-4 flex items-center gap-2 dark:text-slate-200"><i data-lucide="trending-up" class="text-secondary w-4 h-4"></i> Ø±ÙˆÙ†Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡</h3>
                        <div class="h-[200px] flex justify-center"><canvas id="trendChart"></canvas></div>
                    </div>
                </section>
                
                <section class="glass p-5 rounded-3xl border border-emerald-100 dark:border-emerald-900/30 bg-emerald-50/30 dark:bg-emerald-900/10">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-sm text-emerald-800 dark:text-emerald-400 flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Ø·Ø±Ø­ ØªØ³ÙˆÛŒÙ‡</h3>
                        <button onclick="shareSettlementOnWhatsApp()" class="text-xs bg-emerald-500 text-white px-2 py-1 rounded-lg hover:bg-emerald-600 flex gap-1 items-center transition"><i data-lucide="message-circle" class="w-3 h-3"></i> Ø§Ø±Ø³Ø§Ù„</button>
                    </div>
                    <div id="settlement-plan" class="grid grid-cols-1 gap-2 max-h-[250px] overflow-y-auto custom-scroll pr-1"></div>
                </section>
            </div>
        </main>

        <main id="view-transactions" class="view-section hidden space-y-6 fade-in">
            <div class="glass p-5 md:p-6 rounded-3xl border-t-4 border-primary">
                <div class="type-switch">
                    <div id="type-expense" onclick="setTxType('expense')" class="type-btn active-expense"><i data-lucide="shopping-cart" class="inline w-4 h-4 ml-1"></i> Ù‡Ø²ÛŒÙ†Ù‡</div>
                    <div id="type-transfer" onclick="setTxType('transfer')" class="type-btn"><i data-lucide="banknote" class="inline w-4 h-4 ml-1"></i> ØªØ³ÙˆÛŒÙ‡/Ø§Ù†ØªÙ‚Ø§Ù„</div>
                </div>

                <form id="txForm" class="space-y-4">
                    <input type="hidden" id="txId">
                    <input type="hidden" id="txTypeInput" value="expense">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø¹Ù†ÙˆØ§Ù†</label>
                            <input type="text" id="txTitle" required class="w-full p-3 bg-white dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:outline-none font-bold text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
                            <input type="number" id="txAmount" required class="w-full p-3 bg-white dark:bg-slate-800 dark:text-primary border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:outline-none font-black text-lg text-primary text-left ltr-input">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                            <div class="flex gap-2">
                                <select id="txCategory" class="w-full p-3 bg-white dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:outline-none font-bold text-sm"></select>
                                <button type="button" onclick="manageCategories()" class="bg-indigo-100 dark:bg-slate-700 text-indigo-700 dark:text-white px-3.5 rounded-xl hover:bg-indigo-200 font-bold text-lg" title="Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÙ‡">+</button>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">ØªØ§Ø±ÛŒØ®</label>
                            <input type="text" id="txDate" class="w-full p-3 bg-white dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:outline-none font-bold text-sm text-center cursor-pointer" readonly>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400" id="lbl-payer">Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡</label>
                            <select id="txPayer" required class="w-full p-3 bg-white dark:bg-slate-800 dark:text-white border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-sm"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">ØªØµÙˆÛŒØ± ÙØ§Ú©ØªÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                            <div class="flex gap-2 items-center">
                                <input type="file" id="txImage" accept="image/*" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-slate-700 dark:file:text-white">
                                <div id="image-preview" class="hidden h-10 w-10 rounded bg-cover bg-center border border-slate-200"></div>
                            </div>
                            <input type="hidden" id="txImageData">
                        </div>
                    </div>

                    <div id="expense-split-section" class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between mb-3 gap-2">
                            <span class="text-xs font-black text-slate-700 dark:text-slate-300">ØªÙ‚Ø³ÛŒÙ… Ø¨ÛŒÙ† Ø§Ø¹Ø¶Ø§:</span>
                            <div class="flex gap-2">
                                <button type="button" onclick="toggleAllChecks(true)" class="text-[10px] bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">Ù‡Ù…Ù‡</button>
                                <div class="flex bg-white dark:bg-slate-900 p-1 rounded-lg border dark:border-slate-700 shadow-sm">
                                    <button type="button" onclick="setSplitMode('equal')" id="mode-equal" class="split-mode-btn active px-3 py-1 text-xs font-bold rounded-md">Ù…Ø³Ø§ÙˆÛŒ</button>
                                    <button type="button" onclick="setSplitMode('amount')" id="mode-amount" class="split-mode-btn px-3 py-1 text-xs font-bold rounded-md">Ø¯Ù‚ÛŒÙ‚</button>
                                    <button type="button" onclick="setSplitMode('share')" id="mode-share" class="split-mode-btn px-3 py-1 text-xs font-bold rounded-md">Ø³Ù‡Ù…ÛŒ</button>
                                </div>
                            </div>
                        </div>
                        <div id="split-participants" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3"></div>
                    </div>

                    <div id="transfer-section" class="hidden bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-2xl border border-emerald-200 dark:border-emerald-800">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="arrow-left-circle" class="text-emerald-600"></i>
                            <span class="text-sm font-black text-emerald-800 dark:text-emerald-400">Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ ÙˆØ¬Ù‡ (Ø·Ù„Ø¨Ú©Ø§Ø±):</span>
                        </div>
                        <select id="txReceiver" class="w-full p-3 bg-white dark:bg-slate-800 dark:text-white border border-emerald-300 rounded-xl font-bold text-sm"></select>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full py-3.5 bg-primary text-white rounded-xl font-black shadow-lg shadow-primary/30 active:scale-95 transition flex justify-center items-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i> Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
                    </button>
                </form>
            </div>

            <div class="space-y-4">
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute right-3 top-3.5 text-slate-400 w-5 h-5"></i>
                        <input type="text" id="searchTx" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." class="w-full pr-10 pl-4 py-3 rounded-xl border-none shadow-sm font-bold text-sm bg-white dark:bg-slate-800 dark:text-white">
                    </div>
                    <select id="filterCategory" onchange="loadTransactions()" class="w-1/3 p-3 rounded-xl border-none shadow-sm font-bold text-sm bg-white dark:bg-slate-800 dark:text-white">
                        <option value="">Ù‡Ù…Ù‡</option>
                    </select>
                </div>
                <div id="transaction-list" class="space-y-3 pb-20" data-auto-animate></div>
            </div>
        </main>

        <main id="view-reports" class="view-section hidden space-y-6 fade-in">
            <div class="glass p-4 rounded-3xl flex flex-wrap gap-3 items-center justify-between sticky top-20 z-30">
                <h2 class="font-black text-lg flex items-center gap-2 dark:text-white"><i data-lucide="printer" class="text-primary"></i> Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´Ø§Øª</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="printReport('balance')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-1"><i data-lucide="file-bar-chart-2" class="w-4 h-4"></i> ØªØ±Ø§Ø²Ù†Ø§Ù…Ù‡</button>
                    <button onclick="printReport('settlement')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-1"><i data-lucide="check-circle" class="w-4 h-4"></i> ØªØ³ÙˆÛŒÙ‡</button>
                    <button onclick="printReport('journal')" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-1"><i data-lucide="book-open" class="w-4 h-4"></i> Ø±ÙˆØ²Ù†Ø§Ù…Ù‡</button>
                </div>
            </div>

            <div class="glass p-5 rounded-3xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[500px] border-collapse">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300">
                                <th class="p-3 text-xs font-black text-right">Ø¹Ø¶Ùˆ</th>
                                <th class="p-3 text-xs font-black text-center">Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th>
                                <th class="p-3 text-xs font-black text-center">Ø³Ù‡Ù…</th>
                                <th class="p-3 text-xs font-black text-center">Ù…Ø§Ù†Ø¯Ù‡</th>
                                <th class="p-3 text-xs font-black text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="report-details-card" class="hidden glass p-6 rounded-3xl border-t-4 border-accent fade-in"></div>
        </main>

        <main id="view-members" class="view-section hidden space-y-6 fade-in">
            <div class="glass p-6 rounded-3xl">
                <h2 class="font-black text-lg mb-6 flex items-center gap-2 dark:text-white"><i data-lucide="users" class="text-primary"></i> Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</h2>
                <div class="flex gap-3 mb-6">
                    <input type="text" id="newMemberName" placeholder="Ù†Ø§Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÛŒØ¯..." class="flex-1 p-3 border border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-xl font-bold text-sm">
                    <button onclick="addMember()" class="bg-primary text-white px-6 rounded-xl font-bold hover:bg-primary/90">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
                <div id="members-list-management" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" data-auto-animate></div>
            </div>
        </main>

        <main id="view-settings" class="view-section hidden space-y-6 fade-in">
            <div class="glass p-6 rounded-3xl space-y-6">
                <div>
                    <h2 class="font-black text-lg mb-4 flex items-center gap-2 dark:text-white"><i data-lucide="database" class="text-primary"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button onclick="backupData()" class="py-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-xl font-bold text-sm flex justify-center items-center gap-2 border border-indigo-100 dark:border-indigo-800"><i data-lucide="download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</button>
                        <label class="py-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-xl font-bold text-sm flex justify-center items-center gap-2 cursor-pointer border border-emerald-100 dark:border-emerald-800">
                            <i data-lucide="upload"></i> Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="restoreData(this)">
                        </label>
                        <button onclick="exportExcel()" class="py-3 bg-green-600 text-white rounded-xl font-bold text-sm flex justify-center items-center gap-2 hover:bg-green-700"><i data-lucide="file-spreadsheet"></i> Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
                    </div>
                </div>
                <div>
                    <h2 class="font-black text-lg mb-4 flex items-center gap-2 dark:text-white"><i data-lucide="layers" class="text-primary"></i> Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h2>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newCatName" placeholder="Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯" class="flex-1 p-2 border rounded-lg text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-white">
                        <button onclick="addCategory()" class="bg-slate-800 text-white px-4 rounded-lg text-xs font-bold">Ø«Ø¨Øª</button>
                    </div>
                    <div id="settings-cat-list" class="flex flex-wrap gap-2"></div>
                </div>
                <hr class="border-slate-200 dark:border-slate-700">
                <button onclick="confirmReset()" class="w-full py-4 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 rounded-xl font-black flex justify-center items-center gap-2 border border-rose-200 dark:border-rose-800"><i data-lucide="trash-2"></i> Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col-reverse gap-2"></div>
    <div id="image-modal" onclick="this.classList.add('hidden')" class="fixed inset-0 z-50 bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm"><img id="modal-img" class="max-w-full max-h-full rounded-lg shadow-2xl"></div>
    
    <div id="help-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-3xl shadow-2xl max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-black mb-4 dark:text-white">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ù¾Ù„Ø§Ø³</h2>
            <ul class="space-y-3 text-sm text-slate-700 dark:text-slate-300 list-disc pr-4">
                <li><b>Ù†ØµØ¨ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†:</b> Ø¯Ø± Ø¢ÛŒÙÙˆÙ† Ø¯Ú©Ù…Ù‡ Share Ùˆ Ø³Ù¾Ø³ "Add to Home Screen" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯. Ø¯Ø± Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø² Ù…Ù†ÙˆÛŒ Ú©Ø±ÙˆÙ… Ú¯Ø²ÛŒÙ†Ù‡ "Install App" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</li>
                <li><b>Ø´Ø±ÙˆØ¹ Ú©Ø§Ø±:</b> Ø§Ø¨ØªØ¯Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ "Ø§Ø¹Ø¶Ø§"ØŒ Ù†Ø§Ù… Ø§ÙØ±Ø§Ø¯ Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</li>
                <li><b>Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡:</b> Ø¯Ø± Ø¨Ø®Ø´ ØªØ±Ø§Ú©Ù†Ø´ØŒ "Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. Ø§Ú¯Ø± Ú©Ø³ÛŒ Ù¾ÙˆÙ„ÛŒ Ø®Ø±Ø¬ Ú©Ø±Ø¯Ù‡ Ú©Ù‡ Ø¨Ù‚ÛŒÙ‡ Ø¨Ø§ÛŒØ¯ Ø³Ù‡ÛŒÙ… Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</li>
                <li><b>Ø«Ø¨Øª ØªØ³ÙˆÛŒÙ‡:</b> Ø§Ú¯Ø± Ú©Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯ØŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡ "ØªØ³ÙˆÛŒÙ‡/Ø§Ù†ØªÙ‚Ø§Ù„" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</li>
                <li><b>Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±:</b> Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ø­Ø¬Ù…ØŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ´Ø±Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</li>
                <li><b>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ:</b> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ú¯ÙˆØ´ÛŒ Ø´Ù…Ø§ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯. Ø§Ú¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø­ØªÙ…Ø§Ù‹ Ù‡Ø± Ú†Ù†Ø¯ ÙˆÙ‚Øª ÛŒÚ©Ø¨Ø§Ø± "Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
            </ul>
            <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="mt-6 w-full py-3 bg-primary text-white rounded-xl font-bold">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
        </div>
    </div>

    <div class="print-only" id="print-area"></div>

    <script>
        // --- Core ---
        const DB_NAME = 'HesabdarPlus_Gold';
        const DB_VERSION = 4;
        let db, splitMode = 'equal', currentTxType = 'expense';
        const DEFAULT_CATS = ['Ø®ÙˆØ±Ø§Ú©', 'Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„', 'Ø§Ø¬Ø§Ø±Ù‡/Ù…Ø³Ú©Ù†', 'ØªÙØ±ÛŒØ­', 'Ø®Ø±ÛŒØ¯', 'Ù‚Ø¨ÙˆØ¶', 'Ø³Ø§ÛŒØ±'];

        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await initDB();
            await ensureCategories();
            $('#txDate').persianDatepicker({ format: 'YYYY/MM/DD', autoClose: true, initialValue: true });
            
            // Image Handler
            document.getElementById('txImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file) {
                    if(file.size > 5000000) return showToast('Ø­Ø¬Ù… Ø¹Ú©Ø³ Ø²ÛŒØ§Ø¯ Ø§Ø³Øª (Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)');
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        // Simple Image Compression/Resize Logic could go here, simply storing base64 for now
                        document.getElementById('txImageData').value = ev.target.result;
                        const prev = document.getElementById('image-preview');
                        prev.classList.remove('hidden');
                        prev.style.backgroundImage = `url(${ev.target.result})`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            lucide.createIcons();
            router('dashboard');
        });

        // Theme
        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else document.documentElement.classList.remove('dark');
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        function showHelp() { document.getElementById('help-modal').classList.remove('hidden'); }

        // DB
        function initDB() {
            return new Promise((res, rej) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('members')) d.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
                    if (!d.objectStoreNames.contains('transactions')) d.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    if (!d.objectStoreNames.contains('categories')) d.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                };
                req.onsuccess = (e) => { db = e.target.result; res(db); };
                req.onerror = (e) => rej(e);
            });
        }
        async function ensureCategories() {
            const cats = await DB.getAll('categories');
            if (cats.length === 0) for (let c of DEFAULT_CATS) await DB.add('categories', { name: c });
        }
        const DB = {
            getAll: (s) => new Promise(r => db.transaction(s, 'readonly').objectStore(s).getAll().onsuccess = (e) => r(e.target.result)),
            add: (s, d) => new Promise(r => { const q = db.transaction(s, 'readwrite').objectStore(s).add(d); q.onsuccess = (e) => r(e.target.result); }),
            put: (s, d) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).put(d).onsuccess = () => r()),
            delete: (s, id) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).delete(id).onsuccess = () => r()),
            clear: (s) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).clear().onsuccess = () => r())
        };

        // Router
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const active = document.getElementById(`nav-${view}`);
            if(active) active.classList.add('active');
            
            if (view === 'dashboard') loadDashboard();
            if (view === 'transactions') loadTransactions();
            if (view === 'members') loadMembers();
            if (view === 'reports') loadReports();
            if (view === 'settings') loadSettings();
            window.scrollTo({top:0, behavior:'smooth'});
        }

        // Logic
        function calculateFinancials(members, txs) {
            const stats = {};
            members.forEach(m => stats[m.id] = { id: m.id, name: m.name, paid: 0, share: 0 });
            txs.forEach(t => {
                if (stats[t.payerId]) stats[t.payerId].paid += t.amount;
                let totalWeight = 0;
                for(let uid in t.shares) totalWeight += parseFloat(t.shares[uid]);
                if (totalWeight > 0) {
                    for(let uid in t.shares) {
                        const pid = parseInt(uid);
                        if(stats[pid]) {
                            const w = parseFloat(t.shares[uid]);
                            let myShare = (t.splitMode === 'amount' || t.type === 'transfer') ? w : (w / totalWeight) * t.amount;
                            stats[pid].share += myShare;
                        }
                    }
                }
            });
            return stats;
        }

        function computeSettlement(stats) {
            let db = [], cr = [];
            for (let id in stats) {
                const diff = stats[id].paid - stats[id].share;
                if (diff < -1) db.push({ name: stats[id].name, amt: -diff });
                else if (diff > 1) cr.push({ name: stats[id].name, amt: diff });
            }
            db.sort((a,b)=>b.amt-a.amt); cr.sort((a,b)=>b.amt-a.amt);
            let plan = [];
            while(db.length && cr.length) {
                let d = db[0], c = cr[0];
                let min = Math.min(d.amt, c.amt);
                plan.push({ from: d.name, to: c.name, amt: min });
                d.amt -= min; c.amt -= min;
                if(d.amt < 1) db.shift(); if(c.amt < 1) cr.shift();
            }
            return plan;
        }

        // Dashboard
        async function loadDashboard() {
            const m = await DB.getAll('members');
            const t = await DB.getAll('transactions');
            const expenses = t.filter(x => x.type !== 'transfer');
            const totalExp = expenses.reduce((s, x) => s + x.amount, 0);
            
            document.getElementById('total-expenses').innerText = totalExp.toLocaleString();
            document.getElementById('avg-share').innerText = m.length ? Math.round(totalExp / m.length).toLocaleString() : 0;

            const stats = calculateFinancials(m, t);
            const plan = computeSettlement(stats);
            document.getElementById('settlement-plan').innerHTML = plan.length ? plan.map(p => `
                <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs font-bold shadow-sm">
                    <span class="text-rose-500 dark:text-rose-400 truncate max-w-[80px]">${p.from}</span>
                    <div class="flex flex-col items-center px-1"><i data-lucide="arrow-left" class="w-3 h-3 text-slate-300"></i></div>
                    <span class="text-emerald-600 dark:text-emerald-400 truncate max-w-[80px]">${p.to}</span>
                    <span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-slate-800 dark:text-white ml-2" dir="ltr">${Math.round(p.amt).toLocaleString()}</span>
                </div>
            `).join('') : '<div class="text-center text-emerald-600 dark:text-emerald-400 p-3 text-xs font-bold">Ù‡Ù…Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ ØªØ±Ø§Ø² Ø§Ø³Øª!</div>';
            
            document.getElementById('balance-status').innerText = plan.length === 0 ? "ØªØ±Ø§Ø² (ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯Ù‡)" : "Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªØ³ÙˆÛŒÙ‡";
            document.getElementById('balance-status').className = plan.length === 0 ? "text-lg font-black text-emerald-500 mt-1" : "text-lg font-black text-rose-500 mt-1";
            renderCharts(expenses, t);
            lucide.createIcons();
        }

        let catChart, trendChart;
        function renderCharts(expenses, allTxs) {
            const catCtx = document.getElementById('categoryChart').getContext('2d');
            const catData = {}; expenses.forEach(x => catData[x.category || 'Ø³Ø§ÛŒØ±'] = (catData[x.category || 'Ø³Ø§ÛŒØ±'] || 0) + x.amount);
            if (catChart) catChart.destroy();
            catChart = new Chart(catCtx, { type: 'doughnut', data: { labels: Object.keys(catData), datasets: [{ data: Object.values(catData), backgroundColor: ['#4f46e5', '#10b981', '#f43f5e', '#f59e0b', '#06b6d4', '#8b5cf6'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'right', labels: { font: { family: 'Vazirmatn' }, color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#334155', boxWidth: 10 } } }, maintainAspectRatio: false } });

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const monthData = {}; allTxs.filter(x => x.type !== 'transfer').forEach(x => { const m = x.date.substring(0, 7); monthData[m] = (monthData[m] || 0) + x.amount; });
            const sorted = Object.keys(monthData).sort();
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(trendCtx, { type: 'line', data: { labels: sorted, datasets: [{ label: 'Ù‡Ø²ÛŒÙ†Ù‡', data: sorted.map(m => monthData[m]), borderColor: '#10b981', tension: 0.4, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)' }] }, options: { plugins: { legend: { display: false } }, scales: { x: { ticks: { color: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b' }, grid: { display: false } }, y: { ticks: { color: document.documentElement.classList.contains('dark') ? '#94a3b8' : '#64748b' }, grid: { color: document.documentElement.classList.contains('dark') ? '#334155' : '#e2e8f0' } } }, maintainAspectRatio: false } });
        }

        async function shareSettlementOnWhatsApp() {
            const m = await DB.getAll('members'); const t = await DB.getAll('transactions');
            const plan = computeSettlement(calculateFinancials(m, t));
            if (!plan.length) return showToast('Ø­Ø³Ø§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');
            let text = "*Ø­Ø³Ø§Ø¨Ø¯Ø§Ø± Ù¾Ù„Ø§Ø³ - Ú¯Ø²Ø§Ø±Ø´ ØªØ³ÙˆÛŒÙ‡*\n\n";
            plan.forEach(p => { text += `ğŸ”´ ${p.from} â¬…ï¸ ${Math.round(p.amt).toLocaleString()} â¬…ï¸ ${p.to} ğŸŸ¢\n`; });
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // Transactions
        function setTxType(type) {
            currentTxType = type;
            document.getElementById('txTypeInput').value = type;
            const btnExp = document.getElementById('type-expense');
            const btnTrs = document.getElementById('type-transfer');
            const splitSec = document.getElementById('expense-split-section');
            const transSec = document.getElementById('transfer-section');
            const submitBtn = document.getElementById('submitBtn');
            
            if (type === 'expense') {
                btnExp.className = 'type-btn active-expense'; btnTrs.className = 'type-btn';
                splitSec.classList.remove('hidden'); transSec.classList.add('hidden');
                document.getElementById('lbl-payer').innerText = 'Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡';
                document.getElementById('txTitle').placeholder = "Ù…Ø«Ù„Ø§: Ø´Ø§Ù…ØŒ Ø®Ø±ÛŒØ¯...";
                submitBtn.className = 'w-full py-3.5 bg-primary text-white rounded-xl font-black shadow-lg shadow-primary/30 active:scale-95 transition flex justify-center items-center gap-2';
            } else {
                btnExp.className = 'type-btn'; btnTrs.className = 'type-btn active-transfer';
                splitSec.classList.add('hidden'); transSec.classList.remove('hidden');
                document.getElementById('lbl-payer').innerText = 'Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡ (Ø¨Ø¯Ù‡Ú©Ø§Ø±)';
                document.getElementById('txTitle').value = 'ØªØ³ÙˆÛŒÙ‡ Ø­Ø³Ø§Ø¨';
                submitBtn.className = 'w-full py-3.5 bg-emerald-600 text-white rounded-xl font-black shadow-lg shadow-emerald-500/30 active:scale-95 transition flex justify-center items-center gap-2';
            }
        }

        // New Category Function
        function manageCategories() {
            const n = prompt('Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯:');
            if(n) {
                DB.add('categories', {name:n}).then(() => {
                    loadTransactions(); 
                    showToast('Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                });
            }
        }

        async function loadTransactions() {
            const m = await DB.getAll('members');
            const t = await DB.getAll('transactions');
            const cats = await DB.getAll('categories');
            const pMap = Object.fromEntries(m.map(x=>[x.id,x.name]));
            
            const txPayer = document.getElementById('txPayer');
            const txReceiver = document.getElementById('txReceiver');
            const memOpts = m.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
            txPayer.innerHTML = memOpts; txReceiver.innerHTML = memOpts;
            
            const catSel = document.getElementById('txCategory');
            const filterCat = document.getElementById('filterCategory');
            const catOpts = cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            if(catSel.children.length === 0) catSel.innerHTML = catOpts; 
            if(filterCat.children.length <= 1) filterCat.innerHTML = `<option value="">Ù‡Ù…Ù‡</option>` + catOpts;

            const splitDiv = document.getElementById('split-participants');
            if(splitDiv.innerHTML === '') {
                splitDiv.innerHTML = m.map(x => `
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <input type="checkbox" id="check-${x.id}" data-id="${x.id}" class="w-4 h-4 accent-primary part-check" onchange="updateSplitInputs()" checked>
                        <label for="check-${x.id}" class="text-xs font-bold text-slate-600 dark:text-slate-300 flex-1 truncate cursor-pointer">${x.name}</label>
                        <input type="number" id="input-${x.id}" class="split-input w-14 p-1 text-center text-[10px] border dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded hidden" placeholder="0">
                    </div>
                `).join('');
            }

            const search = document.getElementById('searchTx').value.toLowerCase();
            const catFilter = document.getElementById('filterCategory').value;
            const filtered = t.filter(x => {
                const matchSearch = x.title.toLowerCase().includes(search) || (pMap[x.payerId]||'').toLowerCase().includes(search) || x.amount.toString().includes(search);
                const matchCat = catFilter ? x.category === catFilter : true;
                return matchSearch && matchCat;
            });

            document.getElementById('transaction-list').innerHTML = filtered.sort((a,b)=>b.id-a.id).map(x => {
                const isTr = x.type === 'transfer';
                const icon = isTr ? 'arrow-right-left' : 'shopping-bag';
                const brd = isTr ? 'border-emerald-500' : 'border-primary';
                const bg = isTr ? 'bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20' : 'bg-indigo-50 text-primary dark:bg-indigo-900/20';
                let desc = x.title;
                if(isTr && x.shares) { const recId = Object.keys(x.shares)[0]; desc = `ØªØ³ÙˆÛŒÙ‡: ${pMap[x.payerId]} â” ${pMap[recId]}`; }
                const imgBtn = x.image ? `<button onclick="viewImage('${x.id}')" class="text-xs text-indigo-500 underline ml-2"><i data-lucide="image" class="w-3 h-3 inline"></i></button>` : '';

                return `
                <div class="glass p-4 rounded-2xl flex flex-col justify-between gap-3 border-r-4 ${brd} group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition relative">
                    <div class="flex items-center gap-3">
                        <div class="${bg} p-3 rounded-xl"><i data-lucide="${icon}"></i></div>
                        <div class="flex-1">
                            <div class="font-black text-sm text-slate-800 dark:text-slate-200 flex items-center gap-1">${desc} ${imgBtn}</div>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 px-1.5 rounded">${x.category||'Ø¹Ù…ÙˆÙ…ÛŒ'}</span>
                                <span class="text-[10px] text-slate-400 font-bold">${x.date}</span>
                            </div>
                        </div>
                         <div class="font-black text-lg text-slate-700 dark:text-slate-300" dir="ltr">${x.amount.toLocaleString()}</div>
                    </div>
                    <div class="flex justify-end gap-3 no-print border-t pt-2 border-slate-100 dark:border-slate-800">
                         <button onclick="editTx(${x.id})" class="text-xs font-bold text-amber-500 flex items-center gap-1"><i data-lucide="edit-2" class="w-3 h-3"></i> ÙˆÛŒØ±Ø§ÛŒØ´</button>
                         <button onclick="deleteTx(${x.id})" class="text-xs font-bold text-rose-500 flex items-center gap-1"><i data-lucide="trash" class="w-3 h-3"></i> Ø­Ø°Ù</button>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
            updateSplitInputs();
        }

        document.getElementById('txForm').onsubmit = async (e) => {
            e.preventDefault();
            const idVal = document.getElementById('txId').value;
            const amt = parseInt(document.getElementById('txAmount').value);
            const payerId = parseInt(document.getElementById('txPayer').value);
            const type = currentTxType;
            let shares = {}, mode = splitMode;

            if (type === 'transfer') {
                const receiverId = document.getElementById('txReceiver').value;
                if(payerId == receiverId) return showToast('Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡ Ùˆ Ú¯ÛŒØ±Ù†Ø¯Ù‡ ÛŒÚ©Ø³Ø§Ù† Ù‡Ø³ØªÙ†Ø¯!');
                shares[receiverId] = amt; mode = 'amount';
            } else {
                const checks = document.querySelectorAll('.part-check:checked');
                if(!checks.length) return showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù†ÙØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÙˆØ¯');
                checks.forEach(c => {
                    const pid = c.dataset.id;
                    shares[pid] = (splitMode === 'equal') ? 1 : (parseFloat(document.getElementById(`input-${pid}`).value)||0);
                });
            }

            const tx = {
                title: document.getElementById('txTitle').value, amount: amt, payerId: payerId,
                date: document.getElementById('txDate').value, category: document.getElementById('txCategory').value,
                image: document.getElementById('txImageData').value, shares, splitMode: mode, type
            };

            if(idVal) { tx.id = parseInt(idVal); await DB.put('transactions', tx); showToast('ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯'); } 
            else { await DB.add('transactions', tx); showToast('Ø«Ø¨Øª Ø´Ø¯'); }
            
            resetForm(); loadTransactions();
        };

        function resetForm() {
            document.getElementById('txForm').reset();
            document.getElementById('txId').value = '';
            document.getElementById('txImageData').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            $('#txDate').val(new persianDate().format('YYYY/MM/DD'));
            setTxType('expense');
            document.querySelectorAll('.part-check').forEach(c => c.checked = true);
            setSplitMode('equal');
        }

        function toggleAllChecks(status) { document.querySelectorAll('.part-check').forEach(c => c.checked = status); updateSplitInputs(); }
        function setSplitMode(m) {
            splitMode = m;
            document.querySelectorAll('.split-mode-btn').forEach(b => { b.classList.remove('bg-primary','text-white','active'); b.classList.add('bg-white','dark:bg-slate-700','text-slate-600','dark:text-slate-300'); });
            document.getElementById(`mode-${m}`).classList.remove('bg-white','dark:bg-slate-700','text-slate-600');
            document.getElementById(`mode-${m}`).classList.add('bg-primary','text-white','active');
            updateSplitInputs();
        }
        function updateSplitInputs() {
            document.querySelectorAll('.split-input').forEach(inp => {
                const id = inp.id.split('-')[1];
                const checked = document.getElementById(`check-${id}`).checked;
                if(!checked || splitMode === 'equal') inp.classList.add('hidden');
                else { inp.classList.remove('hidden'); inp.placeholder = splitMode==='amount'?'Ù…Ø¨Ù„Øº':'Ø³Ù‡Ù…'; }
            });
        }
        document.getElementById('searchTx').addEventListener('input', loadTransactions);

        async function viewImage(id) {
            const tx = (await DB.getAll('transactions')).find(x => x.id == id);
            if(tx && tx.image) { document.getElementById('modal-img').src = tx.image; document.getElementById('image-modal').classList.remove('hidden'); }
        }
        async function editTx(id) {
            const tx = (await DB.getAll('transactions')).find(x=>x.id===id);
            setTxType(tx.type || 'expense');
            document.getElementById('txId').value = tx.id;
            document.getElementById('txTitle').value = tx.title;
            document.getElementById('txAmount').value = tx.amount;
            document.getElementById('txPayer').value = tx.payerId;
            document.getElementById('txDate').value = tx.date;
            document.getElementById('txCategory').value = tx.category || DEFAULT_CATS[0];
            if(tx.image) {
                document.getElementById('txImageData').value = tx.image;
                const prev = document.getElementById('image-preview'); prev.classList.remove('hidden'); prev.style.backgroundImage = `url(${tx.image})`;
            }
            if (tx.type === 'transfer') document.getElementById('txReceiver').value = Object.keys(tx.shares)[0];
            else {
                setSplitMode(tx.splitMode);
                document.querySelectorAll('.part-check').forEach(c => {
                    const pid = c.dataset.id;
                    if(tx.shares[pid]) { c.checked = true; document.getElementById(`input-${pid}`).value = tx.shares[pid]; } else c.checked = false;
                });
                updateSplitInputs();
            }
            window.scrollTo({top:0, behavior:'smooth'});
        }
        async function deleteTx(id) { if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { await DB.delete('transactions', id); loadTransactions(); showToast('Ø­Ø°Ù Ø´Ø¯'); } }

        // Members
        function getAvatar(name) {
            const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
            const char = name.charAt(0);
            const color = colors[name.length % colors.length];
            return `<div class="avatar ${color}">${char}</div>`;
        }
        async function loadMembers() {
            const m = await DB.getAll('members');
            document.getElementById('members-list-management').innerHTML = m.map(x => `
                <div class="glass p-4 rounded-2xl flex justify-between items-center border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">${getAvatar(x.name)}<span class="font-bold text-slate-700 dark:text-slate-200">${x.name}</span></div>
                    <div class="flex gap-2">
                        <button onclick="editMember(${x.id},'${x.name}')" class="p-2 text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onclick="deleteMember(${x.id})" class="p-2 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        async function addMember() { const n = document.getElementById('newMemberName').value.trim(); if(n) { await DB.add('members', {name:n}); document.getElementById('newMemberName').value=''; loadMembers(); showToast('Ø¹Ø¶Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯'); } }
        async function editMember(id, old) { const n = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯:', old); if(n) { const m = (await DB.getAll('members')).find(x=>x.id===id); m.name = n; await DB.put('members', m); loadMembers(); } }
        async function deleteMember(id) { const t = await DB.getAll('transactions'); if(t.some(x => x.payerId == id || x.shares[id])) return showToast('Ø®Ø·Ø§: Ø§ÛŒÙ† Ø¹Ø¶Ùˆ ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø§Ø±Ø¯'); if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { await DB.delete('members', id); loadMembers(); } }

        // Reports
        async function loadReports() {
            const m = await DB.getAll('members'); const t = await DB.getAll('transactions');
            const stats = calculateFinancials(m, t);
            let html = '';
            for(let id in stats) {
                const s = stats[id]; const net = s.paid - s.share;
                const clr = net > 0 ? 'text-emerald-600 dark:text-emerald-400' : (net < 0 ? 'text-rose-600 dark:text-rose-400' : 'text-slate-400');
                html += `<tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="p-3 text-sm font-bold text-right dark:text-slate-200">${s.name}</td>
                    <td class="p-3 text-sm text-center dark:text-slate-300" dir="ltr">${Math.round(s.paid).toLocaleString()}</td>
                    <td class="p-3 text-sm text-center dark:text-slate-300" dir="ltr">${Math.round(s.share).toLocaleString()}</td>
                    <td class="p-3 text-sm font-black ${clr} text-center" dir="ltr">${Math.round(net).toLocaleString()}</td>
                    <td class="p-3 text-center"><button onclick="showPersonDetail(${s.id})" class="text-xs bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-2 py-1 rounded">Ø±ÛŒØ²</button></td>
                </tr>`;
            }
            document.getElementById('report-table-body').innerHTML = html;
        }

        async function printReport(type) {
            const m = await DB.getAll('members'); const t = await DB.getAll('transactions');
            const stats = calculateFinancials(m, t); const dateStr = new Date().toLocaleDateString('fa-IR');
            let content = '', title = '', head = (t) => `<div class="print-header"><h1>${t}</h1><p>ØªØ§Ø±ÛŒØ®: ${dateStr}</p></div>`;

            if (type === 'balance') {
                title = 'ØªØ±Ø§Ø²Ù†Ø§Ù…Ù‡ Ú©Ù„'; let rows = '', sp=0, ss=0;
                for(let id in stats) {
                    const s = stats[id], net = s.paid - s.share; sp+=s.paid; ss+=s.share;
                    rows += `<tr><td>${s.name}</td><td>${Math.round(s.paid).toLocaleString()}</td><td>${Math.round(s.share).toLocaleString()}</td><td dir="ltr">${Math.round(net).toLocaleString()}</td></tr>`;
                }
                rows += `<tr style="font-weight:bold;background:#eee"><td>Ø¬Ù…Ø¹</td><td>${Math.round(sp).toLocaleString()}</td><td>${Math.round(ss).toLocaleString()}</td><td>0</td></tr>`;
                content = `${head(title)}<table class="print-table"><thead><tr><th>Ù†Ø§Ù…</th><th>Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ</th><th>Ø³Ù‡Ù…</th><th>Ù…Ø§Ù†Ø¯Ù‡</th></tr></thead><tbody>${rows}</tbody></table>`;
            } else if (type === 'settlement') {
                title = 'Ø·Ø±Ø­ ØªØ³ÙˆÛŒÙ‡'; const plan = computeSettlement(stats);
                if(!plan.length) content = `${head(title)}<div style="text-align:center;padding:50px;">ØªØ±Ø§Ø² Ø§Ø³Øª.</div>`;
                else {
                    const rows = plan.map((p,i) => `<tr><td>${i+1}</td><td>${p.from}</td><td>Ø¨Ù‡</td><td>${p.to}</td><td style="font-weight:bold">${Math.round(p.amt).toLocaleString()}</td><td></td></tr>`).join('');
                    content = `${head(title)}<table class="print-table"><thead><tr><th>#</th><th>Ø¨Ø¯Ù‡Ú©Ø§Ø±</th><th>-</th><th>Ø·Ù„Ø¨Ú©Ø§Ø±</th><th>Ù…Ø¨Ù„Øº</th><th>Ø§Ù…Ø¶Ø§</th></tr></thead><tbody>${rows}</tbody></table>`;
                }
            } else if (type === 'journal') {
                title = 'Ø¯ÙØªØ± Ø±ÙˆØ²Ù†Ø§Ù…Ù‡'; const pMap = Object.fromEntries(m.map(x=>[x.id, x.name]));
                const rows = t.sort((a,b)=>a.date.localeCompare(b.date)).map((t,i) => {
                    const desc = t.type==='transfer' && t.shares ? `ØªØ³ÙˆÛŒÙ‡ Ø¨Ø§ ${pMap[Object.keys(t.shares)[0]]}` : t.title;
                    return `<tr><td>${i+1}</td><td>${t.date}</td><td>${t.type==='transfer'?'ØªØ³ÙˆÛŒÙ‡':'Ù‡Ø²ÛŒÙ†Ù‡'}</td><td>${desc}</td><td>${pMap[t.payerId]}</td><td>${t.amount.toLocaleString()}</td></tr>`;
                }).join('');
                content = `${head(title)}<table class="print-table"><thead><tr><th>#</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†ÙˆØ¹</th><th>Ø´Ø±Ø­</th><th>Ø´Ø®Øµ</th><th>Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${rows}</tbody></table>`;
            }
            document.getElementById('print-area').innerHTML = content; window.print();
        }

        async function showPersonDetail(pid) {
            const m = await DB.getAll('members'); const t = await DB.getAll('transactions');
            const person = m.find(x => x.id === pid); const pMap = Object.fromEntries(m.map(x=>[x.id, x.name]));
            const relTxs = t.filter(x => x.payerId === pid || (x.shares && x.shares[pid] > 0));
            let tP=0, tS=0;
            const rows = relTxs.map(x => {
                const paid = x.payerId === pid ? x.amount : 0;
                let share = 0, tw = 0; for(let u in x.shares) tw += parseFloat(x.shares[u]);
                if(tw>0 && x.shares[pid]) share = (x.splitMode==='amount'||x.type==='transfer') ? x.shares[pid] : (x.shares[pid]/tw)*x.amount;
                tP+=paid; tS+=share;
                const desc = x.type==='transfer' ? (x.payerId===pid?`Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ${pMap[Object.keys(x.shares)[0]]}`:`Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² ${pMap[x.payerId]}`) : x.title;
                return `<tr class="border-b dark:border-slate-700 text-xs"><td class="p-2">${x.date}</td><td class="p-2">${desc}</td><td class="p-2 text-emerald-600">${paid>0?paid.toLocaleString():'-'}</td><td class="p-2 text-rose-500">${Math.round(share).toLocaleString()}</td></tr>`;
            }).join('');
            const c = document.getElementById('report-details-card'); c.classList.remove('hidden');
            c.innerHTML = `<div class="flex justify-between mb-4"><h3 class="font-bold dark:text-white">${person.name}</h3><button onclick="document.getElementById('report-details-card').classList.add('hidden')" class="text-rose-500">Ø¨Ø³ØªÙ†</button></div>
                <div class="grid grid-cols-3 gap-2 text-center mb-4 text-xs font-bold"><div class="bg-emerald-100 p-2 rounded text-emerald-800">Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${tP.toLocaleString()}</div><div class="bg-rose-100 p-2 rounded text-rose-800">Ú©Ù„ Ø³Ù‡Ù…: ${Math.round(tS).toLocaleString()}</div><div class="bg-slate-100 p-2 rounded text-slate-800">Ù…Ø§Ù†Ø¯Ù‡: ${Math.round(tP-tS).toLocaleString()}</div></div>
                <div class="max-h-60 overflow-y-auto"><table class="w-full text-center"><thead><tr class="dark:text-white"><th>ØªØ§Ø±ÛŒØ®</th><th>Ø´Ø±Ø­</th><th>Ù¾Ø±Ø¯Ø§Ø®Øª</th><th>Ø³Ù‡Ù…</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        // Settings
        async function loadSettings() {
            const cats = await DB.getAll('categories');
            document.getElementById('settings-cat-list').innerHTML = cats.map(c => `<span class="bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-lg text-xs flex items-center gap-1 dark:text-white">${c.name} <i onclick="deleteCategory(${c.id})" class="cursor-pointer w-3 h-3 text-red-500" data-lucide="x"></i></span>`).join('');
            lucide.createIcons();
        }
        async function addCategory() { const n = document.getElementById('newCatName').value; if(n) { await DB.add('categories', {name:n}); document.getElementById('newCatName').value=''; loadSettings(); } }
        async function deleteCategory(id) { if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { await DB.delete('categories', id); loadSettings(); } }
        function backupData() { Promise.all([DB.getAll('members'), DB.getAll('transactions'), DB.getAll('categories')]).then(([m,t,c]) => { const b = new Blob([JSON.stringify({m,t,c})], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `HesabdarPlus_Gold_Backup_${Date.now()}.json`; a.click(); }); }
        function restoreData(inp) { const f = inp.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const d = JSON.parse(e.target.result); if(confirm('Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯ØŸ')) { await DB.clear('members'); await DB.clear('transactions'); await DB.clear('categories'); } if(d.m) for(let x of d.m) await DB.put('members', x); if(d.t) for(let x of d.t) await DB.put('transactions', x); if(d.c) for(let x of d.c) await DB.put('categories', x); alert('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯'); location.reload(); }; r.readAsText(f); }
        function exportExcel() { Promise.all([DB.getAll('transactions'), DB.getAll('members')]).then(([txs, mems]) => { const pMap = Object.fromEntries(mems.map(m=>[m.id, m.name])); const rows = txs.map(t => ({ "Ø´Ù†Ø§Ø³Ù‡": t.id, "Ù†ÙˆØ¹": t.type, "Ø¹Ù†ÙˆØ§Ù†": t.title, "Ø¯Ø³ØªÙ‡": t.category, "Ù…Ø¨Ù„Øº": t.amount, "Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡": pMap[t.payerId], "ØªØ§Ø±ÛŒØ®": t.date })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Transactions"); XLSX.writeFile(wb, "HesabdarPlus_Export.xlsx"); }); }
        async function confirmReset() { if(confirm('ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { await DB.clear('members'); await DB.clear('transactions'); await DB.clear('categories'); location.reload(); } }
        
        // Utils
        function showToast(msg) {
            const el = document.createElement('div'); el.className = 'bg-slate-800 text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 text-sm font-bold animate-bounce';
            el.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i> ${msg}`; document.getElementById('toast-container').appendChild(el); lucide.createIcons(); setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>