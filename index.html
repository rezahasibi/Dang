<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <title>حسابدار پلاس | نسخه الماس</title>
    
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: { 
                        brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        surface: { light: '#ffffff', dark: '#0f172a' }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(99, 102, 241, 0.5)',
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/auto-animate/0.7.0/auto-animate.min.js"></script>

    <style>
        /* Modern Reset & Base */
        body { 
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .dark body {
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,10%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,10%,1) 0, transparent 50%);
        }

        /* Glassmorphism Pro */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
        }

        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Navigation */
        .nav-link { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .nav-link.active { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.5); transform: scaleX(0); transition: transform 0.3s; }
        .nav-link.active::after { transform: scaleX(1); }

        /* Inputs */
        .input-box { transition: all 0.3s; }
        .input-box:focus-within { transform: scale(1.01); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15); }

        /* Print Styles */
        @media print {
            body { background: white !important; color: black !important; padding: 0 !important; overflow: visible !important; }
            .no-print, nav, header, .fab-container, #toast-container, .view-section, button, .type-switch, .search-bar, .modal-close { display: none !important; }
            .print-only { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 9999; }
            .glass-panel { box-shadow: none !important; border: none !important; background: white !important; backdrop-filter: none !important; }
            
            /* Print Table Styling */
            table.print-table { width: 100%; border-collapse: collapse; font-family: 'Vazirmatn', sans-serif; margin-top: 20px; font-size: 10pt; }
            table.print-table th, table.print-table td { border: 1px solid #333; padding: 8px; text-align: center; }
            table.print-table th { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; color: black !important; }
            
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
            .print-header h1 { font-size: 20pt; font-weight: 900; margin: 0; }
            .print-header .meta { font-size: 10pt; color: #555; }
            .print-footer { margin-top: 30px; display: flex; justify-content: space-between; padding-top: 20px; }
            .print-sign { width: 150px; border-top: 1px dashed #999; text-align: center; font-size: 9pt; padding-top: 5px; }
            
            @page { margin: 15mm; size: A4 portrait; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="pb-24 md:pb-10 font-sans text-slate-800 dark:text-slate-100 transition-colors duration-500">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 opacity-20 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-500 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-500 rounded-full blur-[120px]"></div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6 no-print">
        
        <header class="glass-panel rounded-3xl p-4 flex flex-col md:flex-row items-center justify-between sticky top-3 z-40 gap-4 shadow-lg shadow-indigo-500/10">
            <div class="flex items-center gap-4 w-full md:w-auto justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-tr from-brand-600 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-brand-500/40 animate-float">
                        <i data-lucide="gem" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="font-black text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-brand-700 to-purple-600 dark:from-brand-300 dark:to-purple-300">حسابدار پلاس</h1>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold tracking-wider uppercase">Diamond Edition</p>
                    </div>
                </div>
                <div class="flex gap-2 md:hidden">
                    <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-700 p-2.5 rounded-xl text-slate-600 dark:text-yellow-400"><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i><i data-lucide="moon" class="w-5 h-5 dark:hidden"></i></button>
                    <button onclick="showHelp()" class="bg-indigo-50 dark:bg-indigo-900/50 p-2.5 rounded-xl text-brand-600 dark:text-indigo-300"><i data-lucide="help-circle" class="w-5 h-5"></i></button>
                </div>
            </div>

            <nav class="flex bg-slate-100/50 dark:bg-slate-800/50 p-1.5 rounded-2xl w-full md:w-auto overflow-x-auto custom-scroll backdrop-blur-md">
                <button onclick="router('dashboard')" id="nav-dashboard" class="nav-link flex-1 md:flex-none px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center"><i data-lucide="layout-grid" class="w-4 h-4"></i> داشبورد</button>
                <button onclick="router('transactions')" id="nav-transactions" class="nav-link flex-1 md:flex-none px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center"><i data-lucide="receipt" class="w-4 h-4"></i> تراکنش</button>
                <button onclick="router('reports')" id="nav-reports" class="nav-link flex-1 md:flex-none px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center"><i data-lucide="pie-chart" class="w-4 h-4"></i> گزارشات</button>
                <button onclick="router('members')" id="nav-members" class="nav-link flex-1 md:flex-none px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center"><i data-lucide="users" class="w-4 h-4"></i> اعضا</button>
                <button onclick="router('settings')" id="nav-settings" class="nav-link flex-1 md:flex-none px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 justify-center"><i data-lucide="settings-2" class="w-4 h-4"></i> تنظیمات</button>
            </nav>

            <div class="hidden md:flex gap-2">
                <button onclick="toggleTheme()" class="bg-slate-100 dark:bg-slate-700/50 p-3 rounded-xl hover:bg-slate-200 transition-colors">
                    <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                </button>
            </div>
        </header>

        <main id="view-dashboard" class="view-section space-y-6 fade-in-up">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="glass-panel p-6 rounded-[2rem] relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-brand-500/10 rounded-full blur-3xl group-hover:bg-brand-500/20 transition duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-bold text-slate-500 dark:text-slate-400">مجموع هزینه کل</span>
                            <div class="bg-brand-100 dark:bg-brand-900/50 p-2 rounded-lg text-brand-600"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                        </div>
                        <h3 id="total-expenses" class="text-3xl font-black text-slate-800 dark:text-white" dir="ltr">0</h3>
                        <p class="text-xs text-slate-400 mt-2 font-medium">تومان</p>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-[2rem] relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl group-hover:bg-emerald-500/20 transition duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-bold text-slate-500 dark:text-slate-400">سهم هر نفر (میانگین)</span>
                            <div class="bg-emerald-100 dark:bg-emerald-900/50 p-2 rounded-lg text-emerald-600"><i data-lucide="calculator" class="w-5 h-5"></i></div>
                        </div>
                        <h3 id="avg-share" class="text-3xl font-black text-slate-800 dark:text-white" dir="ltr">0</h3>
                        <p class="text-xs text-slate-400 mt-2 font-medium">تومان</p>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-[2rem] relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-rose-500/10 rounded-full blur-3xl group-hover:bg-rose-500/20 transition duration-500"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-bold text-slate-500 dark:text-slate-400">وضعیت صندوق</span>
                            <div class="bg-rose-100 dark:bg-rose-900/50 p-2 rounded-lg text-rose-600"><i data-lucide="scale" class="w-5 h-5"></i></div>
                        </div>
                        <h3 id="balance-status" class="text-2xl font-black mt-1">...</h3>
                        <p class="text-xs text-slate-400 mt-2 font-medium">وضعیت تراز حساب‌ها</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <section class="lg:col-span-2 glass-panel p-6 rounded-[2rem] flex flex-col md:flex-row gap-8">
                    <div class="flex-1">
                        <h3 class="font-bold text-sm mb-6 flex items-center gap-2 dark:text-slate-200"><span class="w-2 h-2 rounded-full bg-brand-500"></span> تفکیک هزینه‌ها</h3>
                        <div class="h-[220px] relative"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="w-px bg-slate-200 dark:bg-slate-700 hidden md:block"></div>
                    <div class="flex-1">
                        <h3 class="font-bold text-sm mb-6 flex items-center gap-2 dark:text-slate-200"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> روند ماهانه</h3>
                        <div class="h-[220px] relative"><canvas id="trendChart"></canvas></div>
                    </div>
                </section>
                
                <section class="glass-panel p-6 rounded-[2rem] border border-emerald-100 dark:border-emerald-900/30 bg-emerald-50/30 dark:bg-emerald-900/10 backdrop-blur-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-emerald-800 dark:text-emerald-400 flex items-center gap-2"><i data-lucide="check-circle-2" class="w-5 h-5"></i> طرح تسویه هوشمند</h3>
                        <button onclick="shareSettlementOnWhatsApp()" class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg flex gap-1 items-center transition shadow-lg shadow-emerald-500/30"><i data-lucide="share-2" class="w-3 h-3"></i> ارسال</button>
                    </div>
                    <div id="settlement-plan" class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-2"></div>
                </section>
            </div>
        </main>

        <main id="view-transactions" class="view-section hidden space-y-6 fade-in-up">
            <div class="glass-panel p-5 md:p-8 rounded-[2rem]">
                <div class="flex bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl mb-6 max-w-md mx-auto">
                    <button id="type-expense" onclick="setTxType('expense')" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm bg-white dark:bg-slate-700 text-slate-800 dark:text-white flex items-center justify-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4"></i> هزینه جدید</button>
                    <button id="type-transfer" onclick="setTxType('transfer')" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 dark:text-slate-400 flex items-center justify-center gap-2"><i data-lucide="banknote" class="w-4 h-4"></i> تسویه/پرداخت</button>
                </div>

                <form id="txForm" class="space-y-5">
                    <input type="hidden" id="txId">
                    <input type="hidden" id="txTypeInput" value="expense">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        <div class="space-y-2 input-box">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1">عنوان</label>
                            <input type="text" id="txTitle" required class="w-full p-3.5 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none font-bold text-sm transition-all" placeholder="خرید نان، بنزین...">
                        </div>
                        <div class="space-y-2 input-box">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1">مبلغ (تومان)</label>
                            <div class="relative">
                                <input type="number" id="txAmount" required class="w-full p-3.5 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-brand-500 focus:outline-none font-black text-lg text-brand-600 dark:text-brand-400 text-left ltr-input pl-4" placeholder="0">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 text-xs">$</div>
                            </div>
                        </div>
                        <div class="space-y-2 input-box">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1">دسته‌بندی</label>
                            <div class="flex gap-2">
                                <select id="txCategory" class="flex-1 p-3.5 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-brand-500 focus:outline-none font-bold text-sm"></select>
                                <button type="button" onclick="manageCategories()" class="bg-indigo-100 dark:bg-slate-700 text-brand-600 dark:text-white w-12 rounded-2xl hover:bg-indigo-200 font-bold text-xl flex items-center justify-center transition-colors">+</button>
                            </div>
                        </div>
                        <div class="space-y-2 input-box">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1">تاریخ</label>
                            <div class="relative">
                                <input type="text" id="txDate" class="w-full p-3.5 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-brand-500 focus:outline-none font-bold text-sm cursor-pointer" readonly>
                                <i data-lucide="calendar" class="absolute left-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-2 input-box">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1" id="lbl-payer">پرداخت کننده</label>
                            <select id="txPayer" required class="w-full p-3.5 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl font-bold text-sm focus:ring-2 focus:ring-brand-500 outline-none"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 dark:text-slate-400 mr-1">تصویر فاکتور</label>
                            <label class="flex items-center gap-3 w-full p-3 bg-slate-50 dark:bg-slate-800/50 border border-dashed border-slate-300 dark:border-slate-600 rounded-2xl cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                                <div class="bg-indigo-100 dark:bg-indigo-900/50 p-2 rounded-xl text-brand-600"><i data-lucide="camera" class="w-5 h-5"></i></div>
                                <span class="text-sm text-slate-500 font-medium flex-1" id="file-label">انتخاب تصویر...</span>
                                <div id="image-preview" class="w-10 h-10 rounded-lg bg-cover bg-center hidden ring-2 ring-white dark:ring-slate-700 shadow-sm"></div>
                                <input type="file" id="txImage" accept="image/*" class="hidden">
                                <input type="hidden" id="txImageData">
                            </label>
                        </div>
                    </div>

                    <div id="expense-split-section" class="bg-slate-50 dark:bg-slate-800/30 p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                            <span class="text-sm font-black text-slate-700 dark:text-slate-200 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> تقسیم بین:</span>
                            <div class="flex gap-2">
                                <button type="button" onclick="toggleAllChecks(true)" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1.5 rounded-lg font-bold hover:bg-slate-300 transition">انتخاب همه</button>
                                <div class="flex bg-white dark:bg-slate-900 p-1 rounded-xl border dark:border-slate-700 shadow-sm">
                                    <button type="button" onclick="setSplitMode('equal')" id="mode-equal" class="split-mode-btn active px-3 py-1.5 text-xs font-bold rounded-lg transition-all">مساوی</button>
                                    <button type="button" onclick="setSplitMode('amount')" id="mode-amount" class="split-mode-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all">دقیق</button>
                                    <button type="button" onclick="setSplitMode('share')" id="mode-share" class="split-mode-btn px-3 py-1.5 text-xs font-bold rounded-lg transition-all">سهمی</button>
                                </div>
                            </div>
                        </div>
                        <div id="split-participants" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3"></div>
                    </div>

                    <div id="transfer-section" class="hidden bg-emerald-50 dark:bg-emerald-900/10 p-5 rounded-2xl border border-emerald-200 dark:border-emerald-800/50">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="arrow-left-circle" class="text-emerald-600 w-5 h-5"></i>
                            <span class="text-sm font-black text-emerald-800 dark:text-emerald-400">دریافت کننده وجه (طلبکار):</span>
                        </div>
                        <select id="txReceiver" class="w-full p-3.5 bg-white dark:bg-slate-800 dark:text-white border border-emerald-300 rounded-2xl font-bold text-sm focus:ring-2 focus:ring-emerald-500 outline-none"></select>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full py-4 bg-gradient-to-r from-brand-600 to-brand-700 text-white rounded-2xl font-black shadow-lg shadow-brand-500/40 hover:shadow-brand-500/60 active:scale-[0.98] transition-all flex justify-center items-center gap-2 text-lg">
                        <i data-lucide="check" class="w-5 h-5"></i> <span>ثبت تراکنش</span>
                    </button>
                </form>
            </div>

            <div class="space-y-4 pb-20">
                <div class="flex gap-3">
                    <div class="relative flex-1 group">
                        <i data-lucide="search" class="absolute right-4 top-3.5 text-slate-400 w-5 h-5 group-focus-within:text-brand-500 transition-colors"></i>
                        <input type="text" id="searchTx" placeholder="جستجو در تراکنش‌ها..." class="w-full pr-12 pl-4 py-3 rounded-2xl border-none shadow-sm font-bold text-sm bg-white dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-brand-500">
                    </div>
                    <select id="filterCategory" onchange="loadTransactions()" class="w-1/3 p-3 rounded-2xl border-none shadow-sm font-bold text-sm bg-white dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-brand-500">
                        <option value="">همه دسته‌ها</option>
                    </select>
                </div>
                <div id="transaction-list" class="space-y-4" data-auto-animate></div>
            </div>
        </main>

        <main id="view-reports" class="view-section hidden space-y-6 fade-in-up">
            <div class="glass-panel p-4 rounded-3xl flex flex-wrap gap-3 items-center justify-between sticky top-20 z-30 shadow-md">
                <h2 class="font-black text-lg flex items-center gap-2 dark:text-white mr-2"><i data-lucide="printer" class="text-brand-500"></i> چاپ گزارشات</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="printReport('balance')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg shadow-indigo-500/30 transition-transform hover:-translate-y-1"><i data-lucide="file-bar-chart-2" class="w-4 h-4"></i> ترازنامه</button>
                    <button onclick="printReport('settlement')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg shadow-emerald-500/30 transition-transform hover:-translate-y-1"><i data-lucide="check-circle" class="w-4 h-4"></i> تسویه</button>
                    <button onclick="printReport('journal')" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg shadow-slate-500/30 transition-transform hover:-translate-y-1"><i data-lucide="book-open" class="w-4 h-4"></i> روزنامه</button>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-[2rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[600px] border-collapse">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-400">
                                <th class="p-4 text-xs font-black text-right rounded-r-xl">عضو</th>
                                <th class="p-4 text-xs font-black text-center">پرداختی (تومان)</th>
                                <th class="p-4 text-xs font-black text-center">سهم (تومان)</th>
                                <th class="p-4 text-xs font-black text-center">وضعیت</th>
                                <th class="p-4 text-xs font-black text-center rounded-l-xl">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <main id="view-members" class="view-section hidden space-y-6 fade-in-up">
            <div class="glass-panel p-6 rounded-[2rem]">
                <h2 class="font-black text-lg mb-6 flex items-center gap-2 dark:text-white"><i data-lucide="users" class="text-brand-500"></i> مدیریت اعضا</h2>
                <div class="flex gap-3 mb-8">
                    <input type="text" id="newMemberName" placeholder="نام عضو جدید..." class="flex-1 p-3.5 border border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white rounded-2xl font-bold text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                    <button onclick="addMember()" class="bg-brand-600 text-white px-6 rounded-2xl font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-transform hover:scale-105">افزودن</button>
                </div>
                <div id="members-list-management" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" data-auto-animate></div>
            </div>
        </main>

        <main id="view-settings" class="view-section hidden space-y-6 fade-in-up">
            <div class="glass-panel p-8 rounded-[2rem] space-y-8">
                <div>
                    <h2 class="font-black text-lg mb-4 flex items-center gap-2 dark:text-white"><i data-lucide="database" class="text-brand-500"></i> پشتیبان‌گیری و بازیابی</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button onclick="backupData()" class="py-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-2xl font-bold text-sm flex justify-center items-center gap-2 border border-indigo-100 dark:border-indigo-800 hover:bg-indigo-100 transition"><i data-lucide="download-cloud"></i> دانلود فایل پشتیبان</button>
                        <label class="py-4 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-2xl font-bold text-sm flex justify-center items-center gap-2 cursor-pointer border border-emerald-100 dark:border-emerald-800 hover:bg-emerald-100 transition">
                            <i data-lucide="upload-cloud"></i> بازیابی اطلاعات
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="restoreData(this)">
                        </label>
                        <button onclick="exportExcel()" class="py-4 bg-green-600 text-white rounded-2xl font-bold text-sm flex justify-center items-center gap-2 hover:bg-green-700 shadow-lg shadow-green-600/30 transition"><i data-lucide="file-spreadsheet"></i> خروجی اکسل</button>
                    </div>
                </div>
                
                <div>
                    <h2 class="font-black text-lg mb-4 flex items-center gap-2 dark:text-white"><i data-lucide="tag" class="text-brand-500"></i> دسته‌بندی‌ها</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newCatName" placeholder="دسته‌بندی جدید" class="flex-1 p-3 border rounded-xl text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-white focus:ring-2 focus:ring-brand-500 outline-none">
                        <button onclick="addCategory()" class="bg-slate-800 text-white px-5 rounded-xl text-xs font-bold hover:bg-slate-900">ثبت</button>
                    </div>
                    <div id="settings-cat-list" class="flex flex-wrap gap-2"></div>
                </div>

                <hr class="border-slate-200 dark:border-slate-700">
                
                <button onclick="confirmReset()" class="w-full py-4 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 rounded-2xl font-black flex justify-center items-center gap-2 border border-rose-200 dark:border-rose-800 hover:bg-rose-100 transition"><i data-lucide="trash-2"></i> پاکسازی کامل اطلاعات و ریست نرم‌افزار</button>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col-reverse gap-2 pointer-events-none"></div>
    
    <div id="image-modal" onclick="this.classList.add('hidden')" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md transition-all cursor-pointer">
        <img id="modal-img" class="max-w-full max-h-full rounded-2xl shadow-2xl ring-4 ring-white/10">
    </div>
    
    <div id="person-modal" class="fixed inset-0 z-50 bg-slate-900/60 hidden flex items-center justify-center p-4 backdrop-blur-sm modal-close" onclick="if(event.target===this) closePersonModal()">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-[2rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden animate-float-up">
            <div class="p-6 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 id="pm-name" class="font-black text-xl dark:text-white">جزئیات حساب</h3>
                <div class="flex gap-2">
                    <button onclick="printPersonReportCurry()" class="bg-indigo-100 text-indigo-700 p-2 rounded-xl hover:bg-indigo-200 transition"><i data-lucide="printer" class="w-5 h-5"></i></button>
                    <button onclick="closePersonModal()" class="bg-rose-100 text-rose-600 p-2 rounded-xl hover:bg-rose-200 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll space-y-4">
                 <div class="grid grid-cols-3 gap-3 text-center text-xs font-bold">
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-2xl text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800">
                        <span class="block opacity-70 mb-1">کل پرداخت</span>
                        <span id="pm-paid" class="text-sm">0</span>
                    </div>
                    <div class="bg-rose-50 dark:bg-rose-900/20 p-3 rounded-2xl text-rose-700 dark:text-rose-400 border border-rose-100 dark:border-rose-800">
                        <span class="block opacity-70 mb-1">سهم از هزینه</span>
                        <span id="pm-share" class="text-sm">0</span>
                    </div>
                    <div id="pm-balance-box" class="bg-slate-100 dark:bg-slate-700 p-3 rounded-2xl text-slate-700 dark:text-slate-300">
                        <span class="block opacity-70 mb-1">مانده نهایی</span>
                        <span id="pm-balance" class="text-sm">0</span>
                    </div>
                 </div>
                 <div class="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-1">
                     <table class="w-full text-center text-xs">
                         <thead class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
                             <tr><th class="p-2 rounded-r-xl">تاریخ</th><th class="p-2">شرح</th><th class="p-2">پرداخت</th><th class="p-2 rounded-l-xl">سهم</th></tr>
                         </thead>
                         <tbody id="pm-rows"></tbody>
                     </table>
                 </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="fixed inset-0 z-50 bg-black/60 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md p-8 rounded-[2rem] shadow-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-brand-100 rounded-full flex items-center justify-center text-brand-600"><i data-lucide="life-buoy"></i></div>
                <h2 class="text-xl font-black dark:text-white">راهنما</h2>
            </div>
            <ul class="space-y-4 text-sm text-slate-600 dark:text-slate-300 list-disc pr-5 leading-relaxed">
                <li><b>نصب اپلیکیشن:</b> در آیفون دکمه Share و "Add to Home Screen". در اندروید "Install App".</li>
                <li><b>شروع سریع:</b> ابتدا اعضا را تعریف کنید، سپس اولین هزینه را ثبت کنید.</li>
                <li><b>تسویه حساب:</b> وقتی شخصی بدهی خود را پرداخت می‌کند، از بخش تراکنش گزینه "تسویه/پرداخت" را بزنید.</li>
                <li><b>پشتیبان‌گیری:</b> داده‌ها روی مرورگر شماست. قبل از پاک کردن کش مرورگر، حتما "دانلود فایل پشتیبان" را بزنید.</li>
            </ul>
            <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="mt-8 w-full py-3.5 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition">متوجه شدم</button>
        </div>
    </div>

    <div class="print-only" id="print-area"></div>

    <script>
        // --- Core Constants & Variables ---
        const DB_NAME = 'HesabdarPlus_Diamond';
        const DB_VERSION = 1;
        const DEFAULT_CATS = ['خوراک', 'حمل‌ونقل', 'مسکن/اجاره', 'تفریح', 'خرید', 'قبوض', 'درمان', 'سایر'];
        let db;
        let splitMode = 'equal';
        let currentTxType = 'expense';
        let currentPersonIdForPrint = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await initDB();
            await ensureCategories();
            
            // Setup Datepicker
            $('#txDate').persianDatepicker({ format: 'YYYY/MM/DD', autoClose: true, initialValue: true });
            
            // Image Handler with Preview
            document.getElementById('txImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file) {
                    if(file.size > 5000000) return showToast('حجم عکس زیاد است (حداکثر 5 مگابایت)');
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('txImageData').value = ev.target.result;
                        const prev = document.getElementById('image-preview');
                        prev.classList.remove('hidden');
                        prev.style.backgroundImage = `url(${ev.target.result})`;
                        document.getElementById('file-label').innerText = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });

            lucide.createIcons();
            router('dashboard');
        });

        // --- Theme Engine ---
        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else document.documentElement.classList.remove('dark');
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            renderChartsOnThemeChange();
        }
        function showHelp() { document.getElementById('help-modal').classList.remove('hidden'); }

        // --- IndexedDB Wrapper ---
        function initDB() {
            return new Promise((res, rej) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('members')) d.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
                    if (!d.objectStoreNames.contains('transactions')) d.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    if (!d.objectStoreNames.contains('categories')) d.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                };
                req.onsuccess = (e) => { db = e.target.result; res(db); };
                req.onerror = (e) => rej(e);
            });
        }
        async function ensureCategories() {
            const cats = await DB.getAll('categories');
            if (cats.length === 0) for (let c of DEFAULT_CATS) await DB.add('categories', { name: c });
        }
        const DB = {
            getAll: (s) => new Promise(r => db.transaction(s, 'readonly').objectStore(s).getAll().onsuccess = (e) => r(e.target.result)),
            add: (s, d) => new Promise(r => { const q = db.transaction(s, 'readwrite').objectStore(s).add(d); q.onsuccess = (e) => r(e.target.result); }),
            put: (s, d) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).put(d).onsuccess = () => r()),
            delete: (s, id) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).delete(id).onsuccess = () => r()),
            clear: (s) => new Promise(r => db.transaction(s, 'readwrite').objectStore(s).clear().onsuccess = () => r())
        };

        // --- Router ---
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            // Update Nav
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active', 'bg-gradient-to-r');
                el.classList.add('text-slate-600', 'dark:text-slate-300');
            });
            const active = document.getElementById(`nav-${view}`);
            if(active) {
                active.classList.add('active');
                active.classList.remove('text-slate-600', 'dark:text-slate-300');
            }
            
            if (view === 'dashboard') loadDashboard();
            if (view === 'transactions') loadTransactions();
            if (view === 'members') loadMembers();
            if (view === 'reports') loadReports();
            if (view === 'settings') loadSettings();
            window.scrollTo({top:0, behavior:'smooth'});
        }

        // --- Logic: Financial Core ---
        function calculateFinancials(members, txs) {
            const stats = {};
            members.forEach(m => stats[m.id] = { id: m.id, name: m.name, paid: 0, share: 0 });
            txs.forEach(t => {
                if (stats[t.payerId]) stats[t.payerId].paid += t.amount;
                let totalWeight = 0;
                // Calculate total weight/amount for valid splits
                for(let uid in t.shares) {
                     if(stats[uid]) totalWeight += parseFloat(t.shares[uid]);
                }
                
                if (totalWeight > 0) {
                    for(let uid in t.shares) {
                        const pid = parseInt(uid);
                        if(stats[pid]) {
                            const w = parseFloat(t.shares[uid]);
                            let myShare = 0;
                            if (t.type === 'transfer' || t.splitMode === 'amount') {
                                myShare = w;
                            } else {
                                myShare = (w / totalWeight) * t.amount;
                            }
                            stats[pid].share += myShare;
                        }
                    }
                }
            });
            return stats;
        }

        function computeSettlement(stats) {
            let db = [], cr = [];
            for (let id in stats) {
                const diff = stats[id].paid - stats[id].share;
                if (diff < -1) db.push({ name: stats[id].name, amt: -diff }); // Debtor
                else if (diff > 1) cr.push({ name: stats[id].name, amt: diff }); // Creditor
            }
            db.sort((a,b)=>b.amt-a.amt); cr.sort((a,b)=>b.amt-a.amt);
            
            let plan = [];
            while(db.length && cr.length) {
                let d = db[0], c = cr[0];
                let min = Math.min(d.amt, c.amt);
                plan.push({ from: d.name, to: c.name, amt: min });
                d.amt -= min; c.amt -= min;
                if(d.amt < 1) db.shift(); 
                if(c.amt < 1) cr.shift();
            }
            return plan;
        }

        // --- Dashboard Module ---
        let catChart, trendChart;
        async function loadDashboard() {
            const m = await DB.getAll('members');
            const t = await DB.getAll('transactions');
            const expenses = t.filter(x => x.type !== 'transfer');
            const totalExp = expenses.reduce((s, x) => s + x.amount, 0);
            
            animateValue("total-expenses", 0, totalExp, 1000);
            animateValue("avg-share", 0, m.length ? Math.round(totalExp / m.length) : 0, 1000);

            const stats = calculateFinancials(m, t);
            const plan = computeSettlement(stats);
            
            const planContainer = document.getElementById('settlement-plan');
            if (plan.length) {
                planContainer.innerHTML = plan.map(p => `
                    <div class="bg-white dark:bg-slate-800 p-3.5 rounded-2xl border border-slate-100 dark:border-slate-700 flex justify-between items-center text-sm font-bold shadow-sm hover:shadow-md transition">
                        <span class="text-rose-500 dark:text-rose-400 truncate w-1/4">${p.from}</span>
                        <div class="flex flex-col items-center flex-1 px-2">
                            <span class="text-[10px] text-slate-400 mb-1">پرداخت کند به</span>
                            <i data-lucide="arrow-left" class="w-4 h-4 text-slate-300"></i>
                        </div>
                        <span class="text-emerald-600 dark:text-emerald-400 truncate w-1/4 text-left">${p.to}</span>
                        <span class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg text-slate-800 dark:text-white ml-2 text-xs" dir="ltr">${Math.round(p.amt).toLocaleString()}</span>
                    </div>
                `).join('');
                document.getElementById('balance-status').innerText = "نیازمند تسویه";
                document.getElementById('balance-status').className = "text-2xl font-black mt-1 text-rose-500";
            } else {
                planContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-center text-emerald-600 dark:text-emerald-400 opacity-80">
                    <i data-lucide="check-circle" class="w-12 h-12 mb-2"></i>
                    <span class="font-bold">همه حساب‌ها تراز است!</span>
                </div>`;
                document.getElementById('balance-status').innerText = "تراز (تسویه شده)";
                document.getElementById('balance-status').className = "text-2xl font-black mt-1 text-emerald-500";
            }
            
            renderCharts(expenses, t);
            lucide.createIcons();
        }

        function renderCharts(expenses, allTxs) {
            const isDark = document.documentElement.classList.contains('dark');
            const txtColor = isDark ? '#cbd5e1' : '#475569';
            
            // Category Chart
            const catCtx = document.getElementById('categoryChart').getContext('2d');
            const catData = {}; expenses.forEach(x => catData[x.category || 'سایر'] = (catData[x.category || 'سایر'] || 0) + x.amount);
            if (catChart) catChart.destroy();
            catChart = new Chart(catCtx, { 
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(catData), 
                    datasets: [{ 
                        data: Object.values(catData), 
                        backgroundColor: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b', '#06b6d4', '#8b5cf6', '#ec4899'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'left', labels: { font: { family: 'Vazirmatn', size: 10 }, color: txtColor, boxWidth: 10, usePointStyle: true } } }, 
                    cutout: '75%'
                } 
            });

            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const monthData = {}; allTxs.filter(x => x.type !== 'transfer').forEach(x => { const m = x.date.substring(5, 10); monthData[m] = (monthData[m] || 0) + x.amount; });
            const sortedKeys = Object.keys(monthData).sort();
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(trendCtx, { 
                type: 'bar', 
                data: { 
                    labels: sortedKeys, 
                    datasets: [{ 
                        label: 'هزینه', 
                        data: sortedKeys.map(m => monthData[m]), 
                        backgroundColor: '#10b981', 
                        borderRadius: 6,
                        barThickness: 12
                    }] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { ticks: { color: txtColor, font: {family: 'Vazirmatn'} }, grid: { display: false } }, 
                        y: { ticks: { display: false }, grid: { display: false }, border: {display: false} } 
                    } 
                } 
            });
        }
        function renderChartsOnThemeChange() { if(document.getElementById('view-dashboard').classList.contains('hidden') === false) loadDashboard(); }

        // --- Transaction Module ---
        function setTxType(type) {
            currentTxType = type;
            document.getElementById('txTypeInput').value = type;
            
            const btnExp = document.getElementById('type-expense');
            const btnTrs = document.getElementById('type-transfer');
            const splitSec = document.getElementById('expense-split-section');
            const transSec = document.getElementById('transfer-section');
            const submitBtn = document.getElementById('submitBtn');
            const form = document.getElementById('txForm');
            
            // Animation reset
            form.classList.remove('fade-in-up');
            void form.offsetWidth; 
            form.classList.add('fade-in-up');

            if (type === 'expense') {
                btnExp.className = 'flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm bg-white dark:bg-slate-700 text-slate-800 dark:text-white flex items-center justify-center gap-2';
                btnTrs.className = 'flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 dark:text-slate-400 flex items-center justify-center gap-2';
                splitSec.classList.remove('hidden'); 
                transSec.classList.add('hidden');
                document.getElementById('lbl-payer').innerText = 'پرداخت کننده';
                document.getElementById('txTitle').placeholder = "مثلا: شام، خرید...";
                document.getElementById('txTitle').value = '';
                submitBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i> <span>ثبت تراکنش</span>';
                submitBtn.classList.remove('from-emerald-500', 'to-emerald-600', 'shadow-emerald-500/40');
                submitBtn.classList.add('from-brand-600', 'to-brand-700', 'shadow-brand-500/40');
            } else {
                btnExp.className = 'flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 dark:text-slate-400 flex items-center justify-center gap-2';
                btnTrs.className = 'flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center gap-2';
                splitSec.classList.add('hidden'); 
                transSec.classList.remove('hidden');
                document.getElementById('lbl-payer').innerText = 'پرداخت کننده (بدهکار)';
                document.getElementById('txTitle').value = 'تسویه حساب';
                submitBtn.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i> <span>ثبت تسویه</span>';
                submitBtn.classList.remove('from-brand-600', 'to-brand-700', 'shadow-brand-500/40');
                submitBtn.classList.add('from-emerald-500', 'to-emerald-600', 'shadow-emerald-500/40');
            }
            lucide.createIcons();
        }

        async function loadTransactions() {
            const m = await DB.getAll('members');
            const t = await DB.getAll('transactions');
            const cats = await DB.getAll('categories');
            const pMap = Object.fromEntries(m.map(x=>[x.id,x.name]));
            
            // Populate Selects
            const txPayer = document.getElementById('txPayer');
            const txReceiver = document.getElementById('txReceiver');
            const memOpts = m.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
            if(txPayer.innerHTML !== memOpts) {
                txPayer.innerHTML = memOpts; 
                txReceiver.innerHTML = memOpts;
            }
            
            const catSel = document.getElementById('txCategory');
            const filterCat = document.getElementById('filterCategory');
            const catOpts = cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            if(catSel.innerHTML === '') catSel.innerHTML = catOpts;
            if(filterCat.children.length <= 1) filterCat.innerHTML = `<option value="">همه دسته‌ها</option>` + catOpts;

            // Split Participants
            const splitDiv = document.getElementById('split-participants');
            if(splitDiv.innerHTML === '') {
                splitDiv.innerHTML = m.map(x => `
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-900 p-2.5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm transition-all hover:border-brand-300">
                        <input type="checkbox" id="check-${x.id}" data-id="${x.id}" class="w-5 h-5 accent-brand-600 part-check rounded-md" onchange="updateSplitInputs()" checked>
                        <label for="check-${x.id}" class="text-xs font-bold text-slate-700 dark:text-slate-200 flex-1 truncate cursor-pointer select-none">${x.name}</label>
                        <input type="number" id="input-${x.id}" class="split-input w-16 p-1.5 text-center text-[11px] font-bold border dark:border-slate-600 dark:bg-slate-800 dark:text-white rounded-lg hidden focus:ring-2 focus:ring-brand-500 outline-none" placeholder="0">
                    </div>
                `).join('');
            }

            // Filter List
            const search = document.getElementById('searchTx').value.toLowerCase();
            const catFilter = document.getElementById('filterCategory').value;
            const filtered = t.filter(x => {
                const matchSearch = x.title.toLowerCase().includes(search) || (pMap[x.payerId]||'').toLowerCase().includes(search) || x.amount.toString().includes(search);
                const matchCat = catFilter ? x.category === catFilter : true;
                return matchSearch && matchCat;
            });

            document.getElementById('transaction-list').innerHTML = filtered.sort((a,b)=>b.id-a.id).map(x => {
                const isTr = x.type === 'transfer';
                const icon = isTr ? 'arrow-right-left' : 'shopping-bag';
                const bgIcon = isTr ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-indigo-100 text-brand-600 dark:bg-indigo-900/30 dark:text-brand-400';
                const border = isTr ? 'border-l-4 border-emerald-500' : 'border-l-4 border-brand-500';
                
                let desc = x.title;
                if(isTr && x.shares) { 
                    const recId = Object.keys(x.shares)[0]; 
                    desc = `تسویه: ${pMap[x.payerId]} ➔ ${pMap[recId]}`; 
                }
                
                const hasImg = x.image ? 'visible' : 'invisible';

                return `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl flex items-center justify-between gap-3 shadow-sm hover:shadow-md transition group ${border}">
                    <div class="flex items-center gap-4 flex-1 overflow-hidden">
                        <div class="${bgIcon} p-3 rounded-2xl shrink-0"><i data-lucide="${icon}"></i></div>
                        <div class="min-w-0">
                            <div class="font-black text-sm text-slate-800 dark:text-slate-100 truncate flex items-center gap-1">
                                ${desc}
                                <button onclick="viewImage('${x.id}')" class="${hasImg} text-indigo-500 hover:bg-indigo-50 rounded p-1"><i data-lucide="image" class="w-3 h-3"></i></button>
                            </div>
                            <div class="flex gap-2 mt-1.5 items-center">
                                <span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 px-2 py-0.5 rounded-md font-bold">${x.category||'عمومی'}</span>
                                <span class="text-[10px] text-slate-400 font-bold flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${x.date}</span>
                                <span class="text-[10px] text-slate-500 font-bold px-1">${pMap[x.payerId]}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                         <div class="font-black text-lg text-slate-700 dark:text-slate-200" dir="ltr">${x.amount.toLocaleString()}</div>
                         <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity no-print">
                            <button onclick="editTx(${x.id})" class="p-1.5 text-amber-500 hover:bg-amber-50 rounded-lg"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                            <button onclick="deleteTx(${x.id})" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded-lg"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                         </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
            updateSplitInputs();
        }

        document.getElementById('txForm').onsubmit = async (e) => {
            e.preventDefault();
            const idVal = document.getElementById('txId').value;
            const amt = parseInt(document.getElementById('txAmount').value);
            const payerId = parseInt(document.getElementById('txPayer').value);
            const type = currentTxType;
            let shares = {}, mode = splitMode;

            if (type === 'transfer') {
                const receiverId = document.getElementById('txReceiver').value;
                if(payerId == receiverId) return showToast('خطا: مبدا و مقصد یکسان است');
                shares[receiverId] = amt; 
                mode = 'amount';
            } else {
                const checks = document.querySelectorAll('.part-check:checked');
                if(!checks.length) return showToast('حداقل یک نفر باید انتخاب شود');
                checks.forEach(c => {
                    const pid = c.dataset.id;
                    const inp = document.getElementById(`input-${pid}`);
                    shares[pid] = (splitMode === 'equal') ? 1 : (parseFloat(inp.value)||0);
                });
            }

            const tx = {
                title: document.getElementById('txTitle').value, 
                amount: amt, 
                payerId: payerId,
                date: document.getElementById('txDate').value, 
                category: document.getElementById('txCategory').value,
                image: document.getElementById('txImageData').value, 
                shares, 
                splitMode: mode, 
                type
            };

            if(idVal) { 
                tx.id = parseInt(idVal); 
                await DB.put('transactions', tx); 
                showToast('تراکنش ویرایش شد'); 
            } else { 
                await DB.add('transactions', tx); 
                showToast('تراکنش با موفقیت ثبت شد'); 
            }
            
            resetForm(); 
            loadTransactions();
        };

        function resetForm() {
            document.getElementById('txForm').reset();
            document.getElementById('txId').value = '';
            document.getElementById('txImageData').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('file-label').innerText = 'انتخاب تصویر...';
            $('#txDate').val(new persianDate().format('YYYY/MM/DD'));
            
            setTxType('expense');
            document.querySelectorAll('.part-check').forEach(c => c.checked = true);
            setSplitMode('equal');
        }

        // --- Split Logic Helpers ---
        function toggleAllChecks(status) { document.querySelectorAll('.part-check').forEach(c => c.checked = status); updateSplitInputs(); }
        function setSplitMode(m) {
            splitMode = m;
            document.querySelectorAll('.split-mode-btn').forEach(b => { 
                b.classList.remove('bg-brand-600','text-white','active'); 
                b.classList.add('bg-white','dark:bg-slate-800','text-slate-600','dark:text-slate-300'); 
            });
            const activeBtn = document.getElementById(`mode-${m}`);
            activeBtn.classList.remove('bg-white','dark:bg-slate-800','text-slate-600','dark:text-slate-300');
            activeBtn.classList.add('bg-brand-600','text-white','active');
            updateSplitInputs();
        }
        function updateSplitInputs() {
            document.querySelectorAll('.split-input').forEach(inp => {
                const id = inp.id.split('-')[1];
                const checked = document.getElementById(`check-${id}`).checked;
                if(!checked || splitMode === 'equal') inp.classList.add('hidden');
                else { 
                    inp.classList.remove('hidden'); 
                    inp.placeholder = splitMode==='amount' ? 'مبلغ' : 'سهم'; 
                }
            });
        }
        document.getElementById('searchTx').addEventListener('input', loadTransactions);

        // --- Tx Actions ---
        async function viewImage(id) {
            const tx = (await DB.getAll('transactions')).find(x => x.id == id);
            if(tx && tx.image) { 
                document.getElementById('modal-img').src = tx.image; 
                document.getElementById('image-modal').classList.remove('hidden'); 
            }
        }
        async function editTx(id) {
            const tx = (await DB.getAll('transactions')).find(x=>x.id===id);
            setTxType(tx.type || 'expense');
            document.getElementById('txId').value = tx.id;
            document.getElementById('txTitle').value = tx.title;
            document.getElementById('txAmount').value = tx.amount;
            document.getElementById('txPayer').value = tx.payerId;
            document.getElementById('txDate').value = tx.date;
            document.getElementById('txCategory').value = tx.category || DEFAULT_CATS[0];
            
            if(tx.image) {
                document.getElementById('txImageData').value = tx.image;
                const prev = document.getElementById('image-preview'); 
                prev.classList.remove('hidden'); 
                prev.style.backgroundImage = `url(${tx.image})`;
            }

            if (tx.type === 'transfer') {
                document.getElementById('txReceiver').value = Object.keys(tx.shares)[0];
            } else {
                setSplitMode(tx.splitMode);
                document.querySelectorAll('.part-check').forEach(c => {
                    const pid = c.dataset.id;
                    if(tx.shares[pid]) { 
                        c.checked = true; 
                        document.getElementById(`input-${pid}`).value = tx.shares[pid]; 
                    } else c.checked = false;
                });
                updateSplitInputs();
            }
            window.scrollTo({top:0, behavior:'smooth'});
        }
        async function deleteTx(id) { 
            if(confirm('آیا از حذف این تراکنش اطمینان دارید؟')) { 
                await DB.delete('transactions', id); 
                loadTransactions(); 
                showToast('حذف شد'); 
            } 
        }

        // --- Members Module ---
        function getAvatar(name) {
            const gradients = [
                'from-red-400 to-orange-500', 'from-blue-400 to-indigo-500', 
                'from-green-400 to-emerald-500', 'from-yellow-400 to-amber-500', 
                'from-purple-400 to-pink-500'
            ];
            const idx = name.length % gradients.length;
            return `<div class="w-10 h-10 rounded-full bg-gradient-to-br ${gradients[idx]} flex items-center justify-center text-white font-bold shadow-md text-sm">${name.charAt(0)}</div>`;
        }
        async function loadMembers() {
            const m = await DB.getAll('members');
            document.getElementById('members-list-management').innerHTML = m.map(x => `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl flex justify-between items-center border border-slate-100 dark:border-slate-700 shadow-sm">
                    <div class="flex items-center gap-3">
                        ${getAvatar(x.name)}
                        <span class="font-bold text-slate-700 dark:text-slate-200">${x.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editMember(${x.id},'${x.name}')" class="p-2 text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-xl transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onclick="deleteMember(${x.id})" class="p-2 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition"><i data-lucide="trash" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        async function addMember() { 
            const n = document.getElementById('newMemberName').value.trim(); 
            if(n) { 
                await DB.add('members', {name:n}); 
                document.getElementById('newMemberName').value=''; 
                loadMembers(); 
                showToast('عضو جدید اضافه شد'); 
            } 
        }
        async function editMember(id, old) { 
            const n = prompt('نام جدید:', old); 
            if(n) { 
                const m = (await DB.getAll('members')).find(x=>x.id===id); 
                m.name = n; 
                await DB.put('members', m); 
                loadMembers(); 
            } 
        }
        async function deleteMember(id) { 
            const t = await DB.getAll('transactions'); 
            if(t.some(x => x.payerId == id || x.shares[id])) return showToast('خطا: این عضو تراکنش دارد و حذف نمی‌شود'); 
            if(confirm('آیا مطمئن هستید؟')) { 
                await DB.delete('members', id); 
                loadMembers(); 
            } 
        }

        // --- Reports Module ---
        async function loadReports() {
            const m = await DB.getAll('members'); 
            const t = await DB.getAll('transactions');
            const stats = calculateFinancials(m, t);
            let html = '';
            for(let id in stats) {
                const s = stats[id]; 
                const net = s.paid - s.share;
                const clr = net > 0 ? 'text-emerald-600 dark:text-emerald-400' : (net < 0 ? 'text-rose-600 dark:text-rose-400' : 'text-slate-400');
                const status = net > 0 ? 'طلبکار' : (net < 0 ? 'بدهکار' : 'بی‌حساب');
                
                html += `<tr class="border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition last:border-0">
                    <td class="p-4 text-sm font-bold text-right dark:text-slate-200 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full ${net>0?'bg-emerald-500':(net<0?'bg-rose-500':'bg-slate-300')}"></div>
                        ${s.name}
                    </td>
                    <td class="p-4 text-sm text-center dark:text-slate-300 font-medium" dir="ltr">${Math.round(s.paid).toLocaleString()}</td>
                    <td class="p-4 text-sm text-center dark:text-slate-300 font-medium" dir="ltr">${Math.round(s.share).toLocaleString()}</td>
                    <td class="p-4 text-sm font-black ${clr} text-center" dir="ltr">${Math.round(Math.abs(net)).toLocaleString()} <span class="text-[10px] font-normal opacity-80">${status}</span></td>
                    <td class="p-4 text-center">
                        <button onclick="showPersonDetail(${s.id})" class="text-xs bg-indigo-50 dark:bg-indigo-900/30 text-brand-600 dark:text-indigo-300 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition font-bold shadow-sm border border-indigo-100 dark:border-indigo-800">ریز حساب</button>
                    </td>
                </tr>`;
            }
            document.getElementById('report-table-body').innerHTML = html;
        }

        // --- Printing Logic ---
        async function printReport(type) {
            const m = await DB.getAll('members'); 
            const t = await DB.getAll('transactions');
            const stats = calculateFinancials(m, t); 
            const dateStr = new Date().toLocaleDateString('fa-IR');
            let content = '', title = '', head = (ttl) => `
                <div class="print-header">
                    <h1>${ttl}</h1>
                    <div class="meta">تاریخ گزارش: ${dateStr}</div>
                    <div class="meta">حسابدار پلاس (نسخه الماس)</div>
                </div>`;

            if (type === 'balance') {
                title = 'ترازنامه کل گروه'; 
                let rows = '', sp=0, ss=0;
                for(let id in stats) {
                    const s = stats[id], net = s.paid - s.share; sp+=s.paid; ss+=s.share;
                    const status = net > 0 ? 'طلبکار' : (net < 0 ? 'بدهکار' : '-');
                    rows += `<tr><td>${s.name}</td><td>${Math.round(s.paid).toLocaleString()}</td><td>${Math.round(s.share).toLocaleString()}</td><td dir="ltr">${Math.round(net).toLocaleString()}</td><td>${status}</td></tr>`;
                }
                rows += `<tr style="font-weight:bold;background:#eee"><td>جمع کل</td><td>${Math.round(sp).toLocaleString()}</td><td>${Math.round(ss).toLocaleString()}</td><td>0</td><td>-</td></tr>`;
                content = `${head(title)}<table class="print-table"><thead><tr><th>نام عضو</th><th>پرداختی (تومان)</th><th>سهم هزینه (تومان)</th><th>مانده (تومان)</th><th>وضعیت</th></tr></thead><tbody>${rows}</tbody></table>`;
            } 
            else if (type === 'settlement') {
                title = 'طرح تسویه نهایی'; 
                const plan = computeSettlement(stats);
                if(!plan.length) content = `${head(title)}<div style="text-align:center;padding:50px;font-size:14pt;font-weight:bold;">همه حساب‌ها تراز است و نیازی به پرداخت نیست.</div>`;
                else {
                    const rows = plan.map((p,i) => `<tr><td>${i+1}</td><td style="font-weight:bold">${p.from}</td><td>جهت تسویه بپردازد به</td><td style="font-weight:bold">${p.to}</td><td style="font-weight:bold;font-size:11pt;">${Math.round(p.amt).toLocaleString()} تومان</td><td></td></tr>`).join('');
                    content = `${head(title)}<table class="print-table"><thead><tr><th>ردیف</th><th>بدهکار</th><th>شرح</th><th>طلبکار</th><th>مبلغ</th><th>امضا/تایید</th></tr></thead><tbody>${rows}</tbody></table>
                    <div class="print-footer"><div class="print-sign">امضای مدیر گروه</div></div>`;
                }
            } 
            else if (type === 'journal') {
                title = 'دفتر روزنامه تراکنش‌ها'; 
                const pMap = Object.fromEntries(m.map(x=>[x.id, x.name]));
                const rows = t.sort((a,b)=>a.date.localeCompare(b.date)).map((t,i) => {
                    const desc = t.type==='transfer' && t.shares ? `تسویه با ${pMap[Object.keys(t.shares)[0]]}` : t.title;
                    const typeTxt = t.type==='transfer'?'تسویه':'هزینه';
                    return `<tr><td>${i+1}</td><td>${t.date}</td><td>${typeTxt}</td><td>${desc}</td><td>${pMap[t.payerId]}</td><td>${t.amount.toLocaleString()}</td></tr>`;
                }).join('');
                content = `${head(title)}<table class="print-table"><thead><tr><th>#</th><th>تاریخ</th><th>نوع</th><th>شرح</th><th>شخص</th><th>مبلغ</th></tr></thead><tbody>${rows}</tbody></table>`;
            }
            
            document.getElementById('print-area').innerHTML = content; 
            window.print();
        }

        async function showPersonDetail(pid) {
            currentPersonIdForPrint = pid;
            const m = await DB.getAll('members'); 
            const t = await DB.getAll('transactions');
            const person = m.find(x => x.id === pid); 
            const pMap = Object.fromEntries(m.map(x=>[x.id, x.name]));
            
            const relTxs = t.filter(x => x.payerId === pid || (x.shares && x.shares[pid] > 0));
            let tP=0, tS=0;
            
            const rows = relTxs.map(x => {
                const paid = x.payerId === pid ? x.amount : 0;
                let share = 0, tw = 0; 
                for(let u in x.shares) tw += parseFloat(x.shares[u]);
                
                if(tw>0 && x.shares[pid]) {
                    share = (x.splitMode==='amount' || x.type==='transfer') ? x.shares[pid] : (x.shares[pid]/tw)*x.amount;
                }
                
                tP += paid; 
                tS += share;
                
                let desc = x.title;
                if(x.type==='transfer') {
                    desc = (x.payerId===pid) ? `پرداخت به ${pMap[Object.keys(x.shares)[0]]}` : `دریافت از ${pMap[x.payerId]}`;
                }

                return `<tr class="border-b dark:border-slate-700 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800">
                    <td class="p-3 text-slate-500 dark:text-slate-400">${x.date}</td>
                    <td class="p-3 font-bold text-slate-700 dark:text-slate-200">${desc}</td>
                    <td class="p-3 text-emerald-600 font-bold" dir="ltr">${paid>0 ? paid.toLocaleString() : '-'}</td>
                    <td class="p-3 text-rose-500 font-bold" dir="ltr">${share>0 ? Math.round(share).toLocaleString() : '-'}</td>
                </tr>`;
            }).join('');

            // Fill UI
            document.getElementById('pm-name').innerText = person.name;
            document.getElementById('pm-paid').innerText = tP.toLocaleString() + ' تومان';
            document.getElementById('pm-share').innerText = Math.round(tS).toLocaleString() + ' تومان';
            
            const net = tP - tS;
            const balEl = document.getElementById('pm-balance');
            const balBox = document.getElementById('pm-balance-box');
            balEl.innerText = Math.round(Math.abs(net)).toLocaleString() + ' تومان ' + (net>0?'(طلبکار)':'(بدهکار)');
            balBox.className = net > 0 ? "bg-emerald-100 p-3 rounded-2xl text-emerald-800" : (net<0 ? "bg-rose-100 p-3 rounded-2xl text-rose-800" : "bg-slate-100 p-3 rounded-2xl text-slate-800");

            document.getElementById('pm-rows').innerHTML = rows || '<tr><td colspan="4" class="p-4 text-slate-400">تراکنشی یافت نشد</td></tr>';
            
            // Show Modal
            document.getElementById('person-modal').classList.remove('hidden');
        }

        function closePersonModal() {
            document.getElementById('person-modal').classList.add('hidden');
        }

        function printPersonReportCurry() {
            if(currentPersonIdForPrint) printPersonReport(currentPersonIdForPrint);
        }

        async function printPersonReport(pid) {
            const m = await DB.getAll('members'); 
            const t = await DB.getAll('transactions');
            const person = m.find(x => x.id === pid); 
            const pMap = Object.fromEntries(m.map(x=>[x.id, x.name]));
            const relTxs = t.filter(x => x.payerId === pid || (x.shares && x.shares[pid] > 0)).sort((a,b)=>a.date.localeCompare(b.date));
            
            let tP=0, tS=0;
            const rows = relTxs.map((x, i) => {
                const paid = x.payerId === pid ? x.amount : 0;
                let share = 0, tw = 0; 
                for(let u in x.shares) tw += parseFloat(x.shares[u]);
                if(tw>0 && x.shares[pid]) share = (x.splitMode==='amount'||x.type==='transfer') ? x.shares[pid] : (x.shares[pid]/tw)*x.amount;
                tP+=paid; tS+=share;
                
                let desc = x.title;
                if(x.type==='transfer') desc = (x.payerId===pid) ? `پرداخت به ${pMap[Object.keys(x.shares)[0]]}` : `دریافت از ${pMap[x.payerId]}`;
                
                return `<tr>
                    <td>${i+1}</td>
                    <td>${x.date}</td>
                    <td>${desc}</td>
                    <td>${paid>0 ? Math.round(paid).toLocaleString() : '-'}</td>
                    <td>${share>0 ? Math.round(share).toLocaleString() : '-'}</td>
                </tr>`;
            }).join('');

            const net = tP - tS;
            const status = net > 0 ? 'طلبکار' : (net < 0 ? 'بدهکار' : 'بی‌حساب');

            const content = `
                <div class="print-header">
                    <h1>صورت‌حساب شخصی: ${person.name}</h1>
                    <div class="meta">تاریخ گزارش: ${new Date().toLocaleDateString('fa-IR')}</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:20px;border:1px solid #ccc;padding:10px;border-radius:5px;">
                    <div>کل پرداختی: <b>${Math.round(tP).toLocaleString()}</b></div>
                    <div>کل سهم هزینه: <b>${Math.round(tS).toLocaleString()}</b></div>
                    <div>مانده نهایی: <b>${Math.round(Math.abs(net)).toLocaleString()} (${status})</b></div>
                </div>
                <table class="print-table">
                    <thead><tr><th>#</th><th>تاریخ</th><th>شرح تراکنش</th><th>پرداختی (تومان)</th><th>سهم (تومان)</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                 <div class="print-footer"><div class="print-sign">امضای ${person.name}</div><div class="print-sign">تایید مدیر گروه</div></div>
            `;
            document.getElementById('print-area').innerHTML = content;
            window.print();
        }

        async function shareSettlementOnWhatsApp() {
            const m = await DB.getAll('members'); const t = await DB.getAll('transactions');
            const plan = computeSettlement(calculateFinancials(m, t));
            if (!plan.length) return showToast('حسابی برای تسویه وجود ندارد!');
            let text = "*حسابدار پلاس - گزارش تسویه*\n------------------\n";
            plan.forEach(p => { text += `🔴 ${p.from} \n⬅️ مبلغ: ${Math.round(p.amt).toLocaleString()} تومان \n🟢 واریز به: ${p.to}\n\n`; });
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- Settings & Utils ---
        async function loadSettings() {
            const cats = await DB.getAll('categories');
            document.getElementById('settings-cat-list').innerHTML = cats.map(c => `
                <span class="bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-xl text-xs flex items-center gap-2 dark:text-white transition hover:bg-slate-300">
                    ${c.name} <i onclick="deleteCategory(${c.id})" class="cursor-pointer w-3 h-3 text-rose-500 hover:scale-125 transition" data-lucide="x"></i>
                </span>`).join('');
            lucide.createIcons();
        }
        async function addCategory() { const n = document.getElementById('newCatName').value; if(n) { await DB.add('categories', {name:n}); document.getElementById('newCatName').value=''; loadSettings(); } }
        async function deleteCategory(id) { if(confirm('حذف شود؟')) { await DB.delete('categories', id); loadSettings(); } }
        function manageCategories() { const n = prompt('نام دسته‌بندی جدید:'); if(n) { DB.add('categories', {name:n}).then(() => { loadTransactions(); showToast('دسته‌بندی اضافه شد'); }); } }
        
        function backupData() { Promise.all([DB.getAll('members'), DB.getAll('transactions'), DB.getAll('categories')]).then(([m,t,c]) => { const b = new Blob([JSON.stringify({m,t,c})], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `HesabdarPlus_Diamond_Backup_${Date.now()}.json`; a.click(); }); }
        function restoreData(inp) { const f = inp.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { try { const d = JSON.parse(e.target.result); if(confirm('هشدار: تمام اطلاعات فعلی جایگزین می‌شود. ادامه می‌دهید؟')) { await DB.clear('members'); await DB.clear('transactions'); await DB.clear('categories'); if(d.m) for(let x of d.m) await DB.put('members', x); if(d.t) for(let x of d.t) await DB.put('transactions', x); if(d.c) for(let x of d.c) await DB.put('categories', x); alert('بازیابی با موفقیت انجام شد'); location.reload(); } } catch(err){alert('فایل نامعتبر است')} }; r.readAsText(f); }
        function exportExcel() { Promise.all([DB.getAll('transactions'), DB.getAll('members')]).then(([txs, mems]) => { const pMap = Object.fromEntries(mems.map(m=>[m.id, m.name])); const rows = txs.map(t => ({ "شناسه": t.id, "نوع": t.type==='transfer'?'تسویه':'هزینه', "عنوان": t.title, "دسته": t.category, "مبلغ": t.amount, "پرداخت کننده": pMap[t.payerId], "تاریخ": t.date })); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Transactions"); XLSX.writeFile(wb, "HesabdarPlus_Export.xlsx"); }); }
        async function confirmReset() { if(confirm('آیا مطمئن هستید؟ تمام اطلاعات پاک خواهد شد و قابل بازگشت نیست.')) { await DB.clear('members'); await DB.clear('transactions'); await DB.clear('categories'); location.reload(); } }
        
        function showToast(msg) {
            const el = document.createElement('div'); el.className = 'bg-slate-800/90 backdrop-blur text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 text-sm font-bold animate-bounce border border-white/10';
            el.innerHTML = `<i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-400"></i> ${msg}`; document.getElementById('toast-container').appendChild(el); lucide.createIcons(); setTimeout(() => el.remove(), 3000);
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>